<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<link rel="icon" href="gio_circle_white_closeup2_512.png">
<link rel="apple-touch-icon" href="apple-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="이름표">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="robots" content="noindex, nofollow">
<title>인생은 이름표 붙이기 게임</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600;700;900&family=Pretendard:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
/* ═══════════════════════════════════════
   기본 테마 및 레이아웃 설정
   ═══════════════════════════════════════ */

:root{
  --bg:#f6f4ef;--bg-side:#f0ede7;--bg-white:#fdfcfa;--bg-card:#ffffff;
  --border:#e4e0d8;--border-l:#ebe8e2;
  --tx:#2c2922;--tx-d:#5c5548;--tx-m:#9a9488;--tx-hint:#bbb4a8;
  --ac:#b08968;--ac-d:#96724e;--ac-light:#d4b896;
  --red:#c05050;--yellow:#fbbf24;
  --r:6px;--r-sm:4px;
  --side-w:280px;--list-w:380px;
  --shadow:0 1px 3px rgba(0,0,0,.06);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Pretendard',-apple-system,sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;overflow:hidden}

/* ═══ LOGIN & LOADING ═══ */
#lockScreen,#loadingScreen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;transition:opacity .3s}
#lockScreen.hidden,#loadingScreen.hidden{display:none;opacity:0;pointer-events:none}
.lock-card{background:var(--bg-white);padding:40px 30px;border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--border);display:flex;flex-direction:column;align-items:center;text-align:center;width:90%;max-width:320px;gap:12px}
.lock-brand{font-family:'Noto Serif KR',serif;font-size:22px;font-weight:700;color:var(--tx)}
.lock-desc{font-size:13px;color:var(--tx-m);margin-bottom:12px}
.lock-err{font-size:12px;color:var(--red);min-height:18px;font-weight:500}

/* Bouncing Loading Animation */
.loading-scene { position: relative; height: 180px; width: 120px; display: flex; align-items: flex-start; justify-content: center; }
.bounce-avatar { width: 90px; height: 90px; border-radius: 50%; border: 3px solid white; box-shadow: 0 6px 20px rgba(0,0,0,.12); object-fit: cover; position: absolute; top: 0; animation: bounce 1.80s cubic-bezier(.36,.07,.19,.97) infinite; transform-origin: center bottom; }
.bounce-shadow { width: 60px; height: 12px; border-radius: 50%; background: radial-gradient(ellipse at center, rgba(150,114,78,.35) 0%, transparent 75%); position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); animation: shadow-pulse 1.80s cubic-bezier(.36,.07,.19,.97) infinite; }
.loading-text { font-size: 13px; color: var(--tx-m); letter-spacing: .5px; margin-top: 16px; animation: fade-text 1.4s ease-in-out infinite; }
@keyframes bounce {
  0%   { top: 70px; transform: scaleX(1.08) scaleY(0.92); }
  8%   { top: 70px; transform: scaleX(1.08) scaleY(0.92); }
  30%  { top: 0px;  transform: scaleX(0.95) scaleY(1.05); }
  50%  { top: 0px;  transform: scaleX(0.95) scaleY(1.05); }
  72%  { top: 70px; transform: scaleX(1.08) scaleY(0.92); }
  80%  { top: 68px; transform: scaleX(1.04) scaleY(0.97); }
  90%  { top: 70px; transform: scaleX(1.08) scaleY(0.92); }
  100% { top: 70px; transform: scaleX(1.08) scaleY(0.92); }
}
@keyframes shadow-pulse {
  0%   { transform: translateX(-50%) scaleX(1.2);  opacity: .85; }
  8%   { transform: translateX(-50%) scaleX(1.2);  opacity: .85; }
  30%  { transform: translateX(-50%) scaleX(0.45); opacity: .28; }
  50%  { transform: translateX(-50%) scaleX(0.45); opacity: .28; }
  72%  { transform: translateX(-50%) scaleX(1.2);  opacity: .85; }
  80%  { transform: translateX(-50%) scaleX(1.08); opacity: .65; }
  90%  { transform: translateX(-50%) scaleX(1.2);  opacity: .85; }
  100% { transform: translateX(-50%) scaleX(1.2);  opacity: .85; }
}
@keyframes fade-text {
  0%, 100% { opacity: .4; }
  50%      { opacity: .9; }
}

/* ═══════════════════════════════════════
   PC LAYOUT 
   ═══════════════════════════════════════ */
.app{display:flex;height:100vh}
.col-header{height:60px;min-height:60px;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px}

/* Sidebar */
.side{width:var(--side-w);min-width:var(--side-w);background:var(--bg-side);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;z-index:30}
@media (min-width: 769px) {
  .side { transition: width 0.3s cubic-bezier(0.2,0.8,0.2,1), min-width 0.3s cubic-bezier(0.2,0.8,0.2,1), opacity 0.2s; }
  .app.sidebar-closed .side { width: 0 !important; min-width: 0 !important; opacity: 0; border-right-width: 0; pointer-events: none; }
}
.side-hdr{display:flex;align-items:center;padding:0 20px;height:60px;min-height:60px;border-bottom:1px solid var(--border);gap:12px}
.brand-wrap{display:flex;align-items:center;gap:12px}
.brand{display:none}
.cat-avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;background:linear-gradient(135deg,#e8ddd0,#d0c4b4);box-shadow:0 2px 8px rgba(0,0,0,.08);flex-shrink:0}
.sync-row{margin-left:auto;display:flex;align-items:center;gap:5px}
.sync-status{font-size:10px;font-family:'JetBrains Mono',monospace;color:#7a9968;cursor:pointer;padding:3px 8px;border-radius:10px;transition:.2s;display:flex;align-items:center;gap:5px}
.sync-status:hover{background:rgba(0,0,0,.04)}
#syncDot{display:inline-block;width:5px;height:5px;border-radius:50%;background:#7a9968}
.sync-btn{display:none}

.side-scroll{flex:1;overflow-y:auto;padding-bottom:16px}
.sec{padding:14px 20px}
.sec-border{border-bottom:1px solid var(--border)}
.sec-t{font-size:12px;font-weight:500;letter-spacing:.8px;text-transform:uppercase;color:var(--tx-m);margin-bottom:8px}

/* PC 어구록 */
.quote-section{padding:16px 20px}
.q-card{cursor:pointer;transition:.2s;padding:14px 20px;border-left:none;background:none;box-shadow:none;border-radius:0;display:block}
.q-card:hover{opacity:.8}
.q-text{font-family:'Noto Serif KR',serif;font-size:14px;font-weight:400;line-height:1.75;color:var(--tx);word-break:keep-all}
.q-by{font-size:10.5px;color:var(--tx-m);margin-top:5px;font-weight:400}
.quote-mark{display:none}
.quote-label{display:none}

/* PC 글쓰기 메뉴 */
.side-nav{padding:0;border-bottom:1px solid var(--border)}
.writing-grid{display:flex;flex-direction:column;padding:14px 20px}
.side-menu{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;border-radius:var(--r);cursor:pointer;transition:.12s;font-size:14px;font-family:'Pretendard',sans-serif;color:var(--tx-d);background:none;border:none;width:100%;text-align:left;font-weight:400;margin-bottom:0;position:relative}
.side-menu:hover{background:rgba(0,0,0,.03)}
.side-menu.on{background:#ede8e0;color:var(--tx);font-weight:400}
.side-menu-l{font-weight:inherit}
.badge-pill{font-size:12px;color:var(--tx-hint);font-family:'JetBrains Mono',monospace;font-weight:400}
.side-menu.on .badge-pill{color:var(--ac-d);font-weight:500}
.wi-arrow{display:none}
.side-menu::before{display:none}

/* 검색 하이라이트 */
mark.highlight { background-color: rgba(251, 191, 36, 0.45); color: inherit; padding: 0 2px; border-radius: 3px; box-shadow: 0 0 0 1px rgba(251,191,36,.2); }

/* PC 루틴 */
.chk-table{display:flex;flex-direction:column;gap:4px}
.chk-week-hdr{display:flex;margin-bottom:3px}
.chk-week-hdr-spacer{width:100px;flex-shrink:0}
.chk-week-hdr .day-labels{display:flex;flex:1}
.chk-week-hdr .day-lbl{flex:1;text-align:center;font-size:9px;color:var(--tx-hint);font-family:'JetBrains Mono',monospace;font-weight:400}
.chk-row{display:flex;align-items:center;border-radius:10px;cursor:pointer;position:relative;overflow:hidden;height:52px;background:var(--bg-white);border:1px solid var(--border-l);transition:.15s;user-select:none}
.chk-row:hover{border-color:var(--border)}
.chk-blob{position:absolute;border-radius:50%;pointer-events:none;opacity:.22}
.chk-pct{position:absolute;top:6px;left:9px;font-size:7px;font-weight:700;font-family:'JetBrains Mono',monospace;color:rgba(0,0,0,.25);z-index:2}
.chk-left{width:100px;flex-shrink:0;z-index:1;padding:0 4px 0 11px;display:flex;align-items:center}
.chk-lb{font-size:12px;font-weight:400;color:var(--tx);white-space:nowrap}
.chk-dots{display:flex;flex:1;z-index:1;align-items:center;justify-content:space-around;padding-right:6px}
.chk-dot{width:18px;height:18px;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:none;border:none;cursor:pointer}
.chk-dot::before{content:'';display:block;width:4px;height:4px;border-radius:50%;border:1px solid #bbb}
.chk-dot.done::before{display:none}
.chk-dot.done::after{content:'✓';font-size:14px;font-weight:500;color:var(--ac);font-family:-apple-system,sans-serif;line-height:1}
.chk-dot.today::before{border-color:var(--ac);width:5px;height:5px}
.chk-dot.today.done::before{display:none}
.chk-dot.today.done::after{color:var(--ac)}

/* PC 기록 */
.st-card{background:none;border-radius:0;padding:0;box-shadow:none;border:none;margin-bottom:0}
.stats-wrap{display:flex;gap:0}
.stat-col{flex:1;display:flex;flex-direction:column;align-items:center;text-align:center;gap:4px;padding:0 12px}
.stat-col+.stat-col{border-left:1px solid var(--border-l)}
.stat-label{font-size:10px;font-weight:500;color:var(--tx-m);margin-bottom:6px}
.stat-big{font-size:22px;font-weight:400;font-family:'JetBrains Mono',monospace;color:var(--tx);line-height:1.1;letter-spacing:-1px}
.stat-sub{font-size:11px;color:var(--tx-hint);margin-top:4px}
.stat-big .unit{font-size:14px;letter-spacing:0;color:var(--tx-m);font-family:'Pretendard',sans-serif}

/* ═══ List Panel (PC & Mobile) ═══ */
.list-panel{width:var(--list-w);min-width:340px;background:var(--bg);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;position:relative}

/* 헤더: 사이드바토글 | [뷰스위처] 중앙 | 검색 */
.lp-hdr{
  height:60px;min-height:60px;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;gap:0;
  border-bottom:1px solid var(--border);
  background:var(--bg);
  position:relative;
}
.sb-toggle{
  width:38px;height:38px;
  display:flex;align-items:center;justify-content:center;
  background:none;border:none;cursor:pointer;
  color:var(--tx-m);border-radius:8px;transition:.12s;flex-shrink:0;
}
.sb-toggle:hover{background:rgba(0,0,0,.05);color:var(--tx-d);}
.sb-toggle svg{width:20px;height:20px;stroke:currentColor;stroke-width:1.8;fill:none;stroke-linecap:round;stroke-linejoin:round;}

.view-switcher{
  display:flex;align-items:center;
  background:rgba(0,0,0,.07);border-radius:9px;
  padding:3px;gap:1px;
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  z-index:2;
}
.vs-btn{
  width:38px;height:30px;
  display:flex;align-items:center;justify-content:center;
  border-radius:7px;border:none;background:transparent;
  cursor:pointer;color:var(--tx-m);transition:.15s;
}
.vs-btn svg{width:17px;height:17px;stroke:currentColor;stroke-width:1.8;fill:none;stroke-linecap:round;stroke-linejoin:round;}
.vs-btn.on{background:var(--bg-white);color:var(--tx-d);box-shadow:0 1px 4px rgba(0,0,0,.12);}

/* 변경된 검색창 UI (아이콘 확장 방식) */
.search-bar { display:flex; align-items:center; background:transparent; border-radius:16px; transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow:hidden; border:1px solid transparent; position:relative; z-index:3; }
.search-bar.active { background:var(--bg-white); border-color:var(--border); padding-right:8px; box-shadow:inset 0 1px 2px rgba(0,0,0,0.02); }
.search-icon-btn { width:38px; height:38px; display:flex; align-items:center; justify-content:center; background:none; border:none; cursor:pointer; color:var(--tx-m); border-radius:8px; transition:all 0.2s; flex-shrink:0; }
.search-icon-btn:hover { background:rgba(0,0,0,.05); color:var(--tx-d); }
.search-bar.active .search-icon-btn { color:var(--ac); background:transparent; }
.search-bar input { width:0; border:none; background:transparent; outline:none; font-size:13px; color:var(--tx); font-family:'Pretendard',sans-serif; transition:width 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding:0; }
.search-bar.active input { width:130px; padding-left:2px; }
.search-bar input::placeholder { color:var(--tx-hint); }
#clearSearchBtn { display:none; background:var(--border); border:none; cursor:pointer; color:var(--tx-d); font-size:10px; width:16px; height:16px; border-radius:50%; margin-left:4px; align-items:center; justify-content:center; flex-shrink:0; }

/* 뷰 컨테이너 (클래스 충돌 방지를 위해 pane-* 사용) */
.pane-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;padding-bottom:60px;}
.pane-photo{flex:1;overflow-y:auto;display:none;padding-bottom:60px;}
.pane-calendar{flex:1;overflow-y:auto;display:none;padding-bottom:60px;}

/* 목록 뷰 (v2 시안) */
.lp-pin-hdr{
  font-size:10.5px;font-weight:600;color:var(--tx-hint);
  padding:0 14px;height:34px;min-height:34px;
  display:flex;align-items:center;gap:5px;
  position:sticky;top:0;background:var(--bg);z-index:5;
  border-bottom:1px solid var(--border-l);letter-spacing:.3px;
}
.lp-month-hdr{
  font-size:10.5px;font-weight:600;color:var(--tx-m);
  padding:0 14px;height:34px;min-height:34px;
  display:flex;align-items:center;
  position:sticky;top:0;background:var(--bg);z-index:5;
  border-bottom:1px solid var(--border-l);
}
.lp-item{
  display:flex;padding:11px 14px;gap:11px;
  cursor:pointer;border-bottom:1px solid var(--border-l);
  border-left:3px solid transparent;transition:.1s;align-items:flex-start;position:relative;
}
.lp-item:hover{background:rgba(0,0,0,.015);}
.lp-item.on{background:rgba(176,137,104,.1);}
.lp-date-wrap{text-align:center;min-width:40px;display:flex;flex-direction:column;align-items:center;}
.lp-dow{font-size:10px;color:var(--tx-hint);font-weight:500;}
.lp-day{font-size:18px;font-weight:700;color:var(--tx-d);line-height:1.1;}
.lp-text-wrap{flex:1;min-width:0;display:flex;flex-direction:column;gap:2px;}
.lp-item-title{font-size:13.5px;font-weight:700;color:var(--tx);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lp-item-tags{font-size:11px;color:#8ba57c;font-weight:600;letter-spacing:-.2px;}
.lp-item-preview{font-size:12.5px;color:var(--tx-m);overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;line-height:1.5;}
.lp-item-meta{font-size:10px;color:var(--tx-hint);margin-top:2px;}
.lp-thumb{
  width:52px;min-width:52px;height:52px;border-radius:6px;
  align-self:center;overflow:hidden;
  display:flex;align-items:center;justify-content:center;font-size:22px;
}
.quote-txt{font-size:12.5px;font-family:'Noto Serif KR',serif;line-height:1.6;color:var(--tx-d);display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}

/* 리스트 아이템 액션 */
.lp-item-actions{position:absolute;top:10px;right:12px;display:flex;gap:1px;opacity:0;transition:opacity .15s}
.lp-item:hover .lp-item-actions{opacity:1}
.lp-action-btn{width:24px;height:24px;border-radius:4px;border:none;background:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--tx-hint);transition:.12s;padding:0}
.lp-action-btn:hover{background:rgba(0,0,0,.05);color:var(--tx-m)}
.lp-action-btn.pin.on{color:var(--ac)}
.lp-action-btn.del:hover{color:var(--red)}
.lp-action-btn svg{width:13px;height:13px;stroke:currentColor;stroke-width:1.8;fill:none;stroke-linecap:round;stroke-linejoin:round}
.lp-action-btn.pin.on svg{fill:currentColor}

/* PC 환경 스와이프 숨김 */
.swipe-actions{display:none}
.fab-btn{display:none}

/* ══ 사진 뷰 (v2 시안) ══ */
.photo-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:2px;
  background:#ccc;
}
.photo-cell{
  position:relative;
  aspect-ratio:1;
  overflow:hidden;
  cursor:pointer;
}
.photo-cell-bg{
  position:absolute;inset:0;
  background-size:cover;
  background-position:center;
  transition:transform .3s ease;
}
.photo-cell:hover .photo-cell-bg{transform:scale(1.05);}
.photo-overlay{
  position:absolute;inset:0;
  background:linear-gradient(to bottom, transparent 35%, rgba(0,0,0,.15) 65%, rgba(0,0,0,.6) 100%);
  pointer-events:none;
}
.photo-date-block{
  position:absolute;
  right:10px;bottom:8px;
  text-align:right;
  pointer-events:none;
  line-height:1;
}
.photo-day-num{
  display:block;
  font-size:42px;
  font-weight:200;
  color:rgba(255,255,255,.97);
  font-family:'Pretendard',sans-serif;
  text-shadow:0 2px 8px rgba(0,0,0,.4);
  letter-spacing:-2px;
  line-height:1;
}
.photo-ym{
  display:block;
  font-size:10.5px;
  color:rgba(255,255,255,.82);
  font-weight:400;
  margin-top:2px;
  text-shadow:0 1px 4px rgba(0,0,0,.4);
  letter-spacing:.2px;
}

/* ══ 캘린더 뷰 (v2 시안) ══ */
.cal-wrap{padding:0 0 40px;}
.cal-month-title{
  font-size:17px;font-weight:700;color:var(--tx);
  padding:18px 14px 8px;
}
.cal-dow-row{
  display:grid;grid-template-columns:repeat(7,1fr);
  padding:0 8px 4px;
}
.cal-dow{
  font-size:10px;color:var(--tx-hint);text-align:center;
  height:22px;display:flex;align-items:center;justify-content:center;font-weight:500;
}
.cal-grid{
  display:grid;grid-template-columns:repeat(7,1fr);
  gap:3px;padding:0 8px 14px;
}
.cal-day{
  aspect-ratio:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  border-radius:8px;cursor:pointer;
  font-size:13px;color:var(--tx-d);font-weight:400;
  transition:.1s;position:relative;overflow:hidden;
}
.cal-day:hover:not(.empty){background:rgba(0,0,0,.04);}
.cal-day.empty{cursor:default;}
.cal-day.has-entry{background:#42C2E8;color:white;font-weight:600;}
.cal-day.has-entry:hover{background:#31b1d8;}
.cal-day.today{border:2px solid #42C2E8;color:#2aa8cc;font-weight:700;}
.cal-day.today.has-entry{background:#42C2E8;color:white;border-color:#2aa8cc;}
.cal-photo-bg{position:absolute;inset:0;}
.cal-day-num{position:relative;z-index:2;font-size:13px;}
.cal-day.has-photo .cal-day-num{color:white;font-weight:700;text-shadow:0 1px 3px rgba(0,0,0,.6);}
.cal-separator{height:1px;background:var(--border-l);margin:0 14px;}


/* ═══ Editor (PC) ═══ */
.editor{flex:1;display:flex;flex-direction:column;background:var(--bg-white);overflow:hidden;position:relative}
.ed-topbar{height:60px;min-height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;border-bottom:1px solid var(--border);background:var(--bg-white);position:relative}
.ed-topbar-left{display:flex;align-items:center;gap:12px}
.ed-save-status{font-size:12px;color:var(--tx-m);font-family:'JetBrains Mono',monospace}
.ed-header-date{font-size:12px;color:var(--tx-m);font-weight:400;position:absolute;left:50%;transform:translateX(-50%)}
.ed-topbar-right{display:flex;gap:8px;align-items:center}
.ed-top-btn{padding:5px 12px;font-size:12px;font-weight:500;color:white;background:var(--ac);border:none;border-radius:var(--r);cursor:pointer;transition:.15s}
.ed-top-btn:hover{opacity:.85}
.ed-btn-done{display:none}

/* ── 고정 툴바 및 드롭다운 (New Design) ── */
.toolbar{display:flex;align-items:center;padding:6px 16px;border-bottom:1px solid var(--border);background:var(--bg-white);gap:2px;flex-wrap:nowrap;overflow:visible;position:relative;z-index:10}
.tb-sep{width:1px;height:16px;background:var(--border-l);margin:0 4px;flex-shrink:0}

/* 제목 드롭다운 버튼 */
.tb-heading-btn{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:5px;border:1px solid transparent;cursor:pointer;color:var(--tx-d);font-size:13px;font-weight:600;font-family:'Pretendard',sans-serif;background:none;transition:.12s;white-space:nowrap;flex-shrink:0;position:relative}
.tb-heading-btn:hover{background:rgba(0,0,0,.03);border-color:var(--border-l)}
.tb-heading-btn svg{width:14px;height:14px;stroke:currentColor;stroke-width:2;fill:none}
.tb-heading-btn .caret{width:10px;height:10px;stroke:var(--tx-m)}

/* 아이콘 버튼들 */
.tb-btn{width:32px;height:30px;display:flex;align-items:center;justify-content:center;background:none;border:1px solid transparent;border-radius:5px;cursor:pointer;color:var(--tx-m);transition:.12s;flex-shrink:0}
.tb-btn:hover{background:rgba(0,0,0,.03);border-color:var(--border-l);color:var(--tx-d)}
.tb-btn svg{width:16px;height:16px;stroke:currentColor;stroke-width:1.8;fill:none;stroke-linecap:round;stroke-linejoin:round}
.tb-btn.active{background:rgba(176,137,104,.1);border-color:var(--ac-light);color:var(--ac-d)}
.tb-btn.media{color:var(--ac)}
.tb-btn.media:hover{background:rgba(176,137,104,.08);border-color:var(--ac-light)}

/* 제목 드롭다운 메뉴 */
.heading-dropdown{position:absolute;top:calc(100% + 6px);left:0;background:var(--bg-white);border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.1);padding:4px;min-width:140px;z-index:100;display:none}
.heading-dropdown.open{display:block;animation:dropIn .15s ease}
@keyframes dropIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.heading-opt{display:flex;align-items:baseline;gap:10px;padding:8px 12px;border-radius:5px;cursor:pointer;transition:.1s}
.heading-opt:hover{background:var(--bg)}
.heading-opt .h-label{font-family:'Noto Serif KR',serif;color:var(--tx);font-weight:600}
.heading-opt .h-size{font-size:10px;color:var(--tx-hint);font-family:'JetBrains Mono',monospace}
.heading-opt .h1{font-size:18px}
.heading-opt .h2{font-size:15px}
.heading-opt .h3{font-size:13px}

/* 플로팅 툴바 */
#floatingToolbar{position:fixed;z-index:999;background:#1c1a17;border-radius:8px;padding:4px;display:none;align-items:center;gap:1px;box-shadow:0 4px 20px rgba(0,0,0,.25),0 1px 4px rgba(0,0,0,.15);animation:popIn .12s ease}
@keyframes popIn{from{opacity:0;transform:scale(.95) translateY(3px)}to{opacity:1;transform:scale(1) translateY(0)}}
#floatingToolbar.show{display:flex}
#floatingToolbar::after{content:'';position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);width:10px;height:10px;background:#1c1a17;clip-path:polygon(0 0, 100% 0, 50% 100%)}
.ft-btn{width:30px;height:28px;display:flex;align-items:center;justify-content:center;background:none;border:none;border-radius:5px;cursor:pointer;color:rgba(255,255,255,.75);font-size:13px;font-weight:700;font-family:'Pretendard',sans-serif;transition:.1s;flex-shrink:0}
.ft-btn:hover{background:rgba(255,255,255,.12);color:white}
.ft-btn svg{width:15px;height:15px;stroke:currentColor;stroke-width:2;fill:none}
.ft-sep{width:1px;height:14px;background:rgba(255,255,255,.15);margin:0 2px}
.ft-btn.highlight-btn{font-size:13px;font-weight:700;color:rgba(255,255,255,.8);letter-spacing:-0.5px}
.ft-btn.highlight-btn .hl-inner{background:rgba(251,191,36,.5);border-radius:3px;padding:1px 4px;font-size:12px;font-weight:700;color:white;line-height:1.3;letter-spacing:0}
.ft-btn.highlight-btn:hover .hl-inner{background:rgba(251,191,36,.8)}

.editor-scroll-area{flex:1;overflow-y:auto;display:flex;flex-direction:column;align-items:center}
.editor-content-wrap{width:100%;max-width:720px;padding:32px 40px 100px;display:flex;flex-direction:column;flex:1}

.ed-title{width:100%;background:none;border:none;font-family:'Pretendard',sans-serif;font-size:24px;font-weight:700;color:var(--tx);outline:none;letter-spacing:-.02em;margin-bottom:6px;line-height:1.35}
.ed-title::placeholder{color:var(--border-l)}

/* 태그 입력 필드 */
.ed-tags-wrap { display:flex; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:1px dashed var(--border-l); gap:8px;}
.ed-tags-wrap svg { width:16px; height:16px; stroke:#8ba57c; stroke-width:2.5; fill:none; flex-shrink:0; }
.ed-tags{width:100%;background:none;border:none;outline:none;font-family:'Pretendard',sans-serif;font-size:14px;color:#8ba57c; font-weight:500; line-height:1.2;}
.ed-tags::placeholder{color:var(--border); font-weight:400;}

.ed-body{width:100%;min-height:100%;outline:none;font-family:'Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic',sans-serif;font-size:16px;line-height:2.0;letter-spacing:0;color:var(--tx);flex:1;word-break:keep-all;font-weight:400;font-feature-settings:'kern' 1}
.ed-body:empty::before{content:attr(data-placeholder);color:var(--border-l)}
.ed-body blockquote{border-left:3px solid var(--ac-light);padding:6px 14px;margin:12px 0;color:var(--tx-d);font-style:italic;background:var(--bg);border-radius:0 6px 6px 0}
.ed-body *:not(h1):not(h2):not(h3):not(blockquote):not(img):not(ul):not(ol):not(li):not(hr){font-family:'Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic',sans-serif !important;font-size:16px !important;line-height:2.0 !important;letter-spacing:0 !important;font-weight:400 !important;color:var(--tx) !important;background:none !important}
.ed-body b,.ed-body strong{font-weight:700 !important}
.ed-body i,.ed-body em{font-style:italic !important}
.ed-body h1,.ed-body h2,.ed-body h3{font-family:'Noto Serif KR',serif;margin:20px 0 10px;font-weight:600}
.ed-body h1{font-size:22px}.ed-body h2{font-size:18px}.ed-body h3{font-size:15px}
.ed-body hr{border:none;border-top:1px solid var(--border);margin:24px 0}
.ed-body ul,.ed-body ol{padding-left:20px;margin:10px 0}
.ed-body img{max-width:100%;height:auto;display:block;margin:1.5em auto;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.08);border:1px solid var(--border)}
.ed-body p, .ed-body div { margin: 0; padding: 0; }

/* PC 하단 글자수 */
.ed-foot{padding:12px 24px;border-top:1px solid var(--border);display:flex;justify-content:center;gap:24px;font-size:12px;color:var(--tx-m);font-family:'JetBrains Mono',monospace;font-weight:400;background:var(--bg);z-index:10}
.ed-foot span{color:var(--tx-d);font-weight:500}

.special-form{padding:20px 0;display:flex;flex-direction:column;gap:14px;border-bottom:1px solid var(--border);margin-bottom:20px}
.sf-field{display:flex;flex-direction:column;gap:6px}.sf-row{display:flex;gap:16px}
.sf-label{font-size:10px;font-weight:500;color:var(--tx-m);letter-spacing:.5px}
.sf-input{width:100%;background:var(--bg-white);border:1px solid var(--border);border-radius:var(--r-sm);padding:7px 10px;font-size:13px;color:var(--tx);font-family:'Pretendard',sans-serif;outline:none}
.sf-input::placeholder{color:var(--border-l)}.sf-input:focus{border-color:var(--ac-light);box-shadow:0 0 0 2px rgba(176,137,104,.08)}

::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* PC 모바일 전용 숨김 */
.mobile-nav-btn{display:none}
.mobile-back-btn{display:none}

/* ═══════════════════════════════════════
   MOBILE (≤768px)
   ═══════════════════════════════════════ */
@media(max-width:768px){
  :root{--bg:#f7f5f0;--bg-card:#ffffff;--bg-side:#f7f5f0;--border:#e8e4dc;--border-l:#f0ede8;--tx:#1a1714;--tx-d:#4a453e;--tx-m:#8a8378;--tx-hint:#b0a898}
  body{background:var(--bg)}

  .app{position:relative;display:block;height:100vh;height:100dvh;overflow:hidden;width:100vw}
  .side{position:absolute;top:0;left:0;width:100%;height:100%;border-right:none;transition:transform .35s ease;background:var(--bg);z-index:10}
  .app.sidebar-closed .side{width:100% !important;min-width:100% !important;} /* 모바일에서는 사이드바 토글 무시 */
  .list-panel{position:absolute;top:0;left:0;width:100%;height:100%;transition:transform .35s cubic-bezier(.2,.8,.2,1),opacity .35s;background:var(--bg);z-index:20;transform:translateX(100%)}
  .editor{position:absolute;top:0;left:0;width:100%;height:100%;z-index:40;transform:translateX(100%);transition:transform .35s cubic-bezier(.2,.8,.2,1)}
  .app.view-list .list-panel{transform:translateX(0);opacity:1}
  .app.view-list .side{transform:translateX(-30%);opacity:.5}
  .app.view-editor .editor{transform:translateX(0)}
  .app.view-editor .list-panel{transform:translateX(0);opacity:1}

  .pc-sidebar-toggle{display:none !important}
  .mobile-nav-btn{display:flex !important;}

  /* ── 1단: 대시보드 ── */
  .side-hdr{padding:16px 20px 12px;background:var(--bg);position:sticky;top:0;z-index:10;border-bottom:1px solid var(--border-l);height:auto;min-height:auto}
  .cat-avatar{width:44px;height:44px;border:2px solid white;box-shadow:0 2px 10px rgba(0,0,0,.08)}
  .brand{display:block;font-family:'Noto Serif KR',serif;font-weight:700;font-size:17px;color:var(--tx)}
  .sync-status{background:rgba(0,0,0,.03);padding:4px 10px;border-radius:12px}
  .side-scroll{padding-bottom:80px}
  .sec-border{border-bottom:none}
  .sec-t{font-size:13px;font-weight:700;text-transform:none;letter-spacing:0;color:var(--tx-hint);margin-bottom:16px;padding-left:4px}

  /* 모바일 어구록 */
  .quote-section{padding:20px}
  .q-card{background:linear-gradient(135deg,#fdfcf8,#f8f4ec);border-radius:16px;padding:24px 22px 20px;box-shadow:0 2px 12px rgba(0,0,0,.04);position:relative}
  .quote-mark{display:block;font-family:'Georgia',serif;font-size:48px;font-weight:900;color:#a09060;opacity:.15;line-height:1;position:absolute;top:10px;left:16px;pointer-events:none}
  .q-text{font-size:15px;font-weight:600;line-height:1.7;font-family:'Noto Serif KR',serif}
  .q-by{font-size:12px;color:var(--tx-d);font-weight:400;margin-top:10px}

  /* 모바일 글쓰기 2열 */
  .side-nav{padding:0 16px 20px;border-bottom:none}
  .writing-grid{display:grid !important;grid-template-columns:1fr 1fr;gap:8px;padding:0}
  .side-menu{background:var(--bg-card);border-radius:12px;padding:14px 14px 12px;box-shadow:0 1px 4px rgba(0,0,0,.03);flex-direction:column;align-items:flex-start;gap:4px;border:1px solid transparent;overflow:hidden;font-weight:600}
  .side-menu.on{border-color:var(--border-l);box-shadow:0 4px 12px rgba(0,0,0,.06)}
  .side-menu::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;border-radius:3px 0 0 3px;display:block !important}
  .side-menu[data-tab="navi"]::before{background:#c4956a}
  .side-menu[data-tab="navi"]{border-color:rgba(196,149,106,.12)}
  .side-menu[data-tab="fiction"]::before{background:#6a9a6a}
  .side-menu[data-tab="fiction"]{border-color:rgba(106,154,106,.12)}
  .side-menu[data-tab="blog"]::before{background:#6a82a8}
  .side-menu[data-tab="blog"]{border-color:rgba(106,130,168,.12)}
  .side-menu[data-tab="book"]::before{background:#8a6a98}
  .side-menu[data-tab="book"]{border-color:rgba(138,106,152,.12)}
  .side-menu[data-tab="quote"]::before{background:#a09060}
  .side-menu[data-tab="quote"]{border-color:rgba(160,144,96,.12)}
  .side-menu[data-tab="memo"]::before{background:#7a8a8a}
  .side-menu[data-tab="memo"]{border-color:rgba(122,138,138,.12)}
  .side-menu-l{font-size:14px;font-weight:600;color:var(--tx);letter-spacing:-.2px}
  .badge-pill{font-size:20px;font-weight:800;color:var(--tx-hint);font-family:'Pretendard',sans-serif}
  .wi-arrow{display:block;position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:14px;color:var(--tx-hint);opacity:.5}

  /* ── 모바일 루틴 ── */
  .chk-table{gap:4px}
  .chk-week-hdr{display:flex !important;margin-bottom:3px}
  .chk-week-hdr-spacer{width:90px;flex-shrink:0}
  .chk-week-hdr .day-labels{display:flex;flex:1}
  .chk-week-hdr .day-lbl{flex:1;text-align:center;font-size:9px;color:var(--tx-hint)}
  .chk-row{background:var(--bg-card);border-radius:10px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.04);height:48px;padding:0;border:none;gap:0;position:relative}
  .chk-blob{position:absolute;border-radius:50%;pointer-events:none;opacity:.25}
  .chk-pct{position:absolute;top:5px;left:8px;font-size:7px;font-weight:700;color:rgba(0,0,0,.25);z-index:2}
  .chk-left{width:90px;flex-shrink:0;z-index:1;padding:0 4px 0 10px;display:flex;align-items:center;min-width:unset;gap:0}
  .chk-info{display:none}
  .chk-lb{font-size:12px;font-weight:400;color:var(--tx);width:auto;min-width:auto;white-space:nowrap}
  .chk-total{display:none}
  .chk-dots{display:flex;flex:1;z-index:1;align-items:center;justify-content:space-around;padding-right:6px;gap:0;margin-left:0}
  .chk-dot{width:18px;height:18px;border-radius:0;background:none;border:none;display:flex;align-items:center;justify-content:center;font-size:0;color:transparent;margin:0;flex-shrink:0}
  .chk-dot::before{content:'';display:block;width:4px;height:4px;border-radius:50%;border:1px solid #bbb}
  .chk-dot.done::before{display:none}
  .chk-dot.done::after{content:'✓';font-size:14px;font-weight:500;color:var(--ac);font-family:-apple-system,sans-serif;line-height:1}
  .chk-dot.today::before{border-color:var(--ac);width:5px;height:5px}
  .chk-dot.today.done::before{display:none}
  .chk-dot.today.done::after{color:var(--ac)}

  /* 모바일 통계 — 2분할 구분선 */
  .st-card{display:none}
  .stats-wrap{display:flex;gap:0;padding:16px 0 24px}
  .stat-col{flex:1;display:flex;flex-direction:column;align-items:center;text-align:center;gap:3px;padding:0 12px}
  .stat-col+.stat-col{border-left:1px solid var(--border-l)}
  .stat-label{font-size:11px;color:var(--tx-m);font-weight:500;margin-bottom:6px}
  .stat-big{font-size:22px;font-weight:400;color:var(--tx);line-height:1.1;letter-spacing:-1px;font-family:'JetBrains Mono',monospace}
  .stat-sub{font-size:11px;color:var(--tx-hint);margin-top:4px}
  .stat-big .unit{font-size:14px;letter-spacing:0;color:var(--tx-m);font-family:'Pretendard',sans-serif}

  /* ── 2단: 리스트 ── */
  .col-header{height:56px;min-height:56px}
  .lp-hdr{background:var(--bg);border-bottom:1px solid var(--border-l);height:56px;min-height:56px}

  .pane-list, .pane-photo, .pane-calendar { padding-bottom:120px !important; overflow-x:hidden; }

  .lp-month-hdr{font-size:12.5px;font-weight:800;color:var(--tx);padding:14px 16px 8px;background:var(--bg);letter-spacing:0;border-bottom:1px solid var(--border-l)}

  .lp-item{padding:12px 16px;gap:14px;border-bottom:1px solid var(--border-l);align-items:flex-start;overflow:visible;position:relative;transition:transform .2s ease}
  .lp-item:active{background:rgba(0,0,0,.02)}
  .lp-item.on{background:#ede8e0;border-left:3px solid transparent}
  .lp-item-actions{display:none !important}

  /* 스와이프 액션 패널 */
  .swipe-actions{display:flex;position:absolute;top:0;left:100%;height:100%;z-index:1}
  .swipe-action{display:flex;align-items:center;justify-content:center;width:80px;height:100%;color:white;font-size:13px;font-weight:700;cursor:pointer}
  .swipe-action.pin-action{background:var(--ac)}
  .swipe-action.del-action{background:var(--red)}
  .swipe-action svg{width:20px;height:20px;stroke:white;stroke-width:2.5;fill:none;stroke-linecap:round;stroke-linejoin:round;margin-bottom:4px}
  .swipe-action span{display:flex;flex-direction:column;align-items:center;gap:2px;font-size:11px}

  /* 데이원 매칭: 콘텐츠 */
  .lp-text-wrap{gap:3px}
  .lp-item-title{font-size:14.5px;font-weight:700;color:var(--tx);line-height:1.35;padding-right:0}
  .lp-item-preview{font-size:13.5px;color:var(--tx-m);line-height:1.5;font-weight:400;-webkit-line-clamp:2}
  .lp-item-meta{font-size:11px;color:var(--tx-hint);margin-top:3px;font-weight:400}
  .quote-txt{font-size:15px;font-weight:500}

  .fab-btn{display:flex;align-items:center;justify-content:center;position:fixed;bottom:32px;right:24px;width:60px;height:60px;border-radius:50%;background:var(--yellow);color:white;border:none;box-shadow:0 6px 20px rgba(251,191,36,.4);cursor:pointer;z-index:90;transition:transform .1s}
  .fab-btn svg{width:28px;height:28px;stroke:white;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;fill:none}
  .fab-btn:active{transform:scale(.9)}

  /* ── 3단: 에디터 ── */
  .ed-topbar{padding-top:calc(env(safe-area-inset-top) + 10px);padding-bottom:10px;padding-left:16px;padding-right:16px;background:var(--yellow);border-bottom:none;height:auto;min-height:calc(env(safe-area-inset-top) + 56px);align-items:center}
  .ed-header-date{font-size:15px;font-weight:700;color:white}
  .ed-top-btn.pc-only{display:none}
  .ed-save-status{display:none}
  .ed-btn-done{display:block;color:white;font-weight:700;background:none;border:none;font-size:16px;cursor:pointer;font-family:'Pretendard',sans-serif;padding:10px 0 10px 10px;margin-left:auto;flex-shrink:0;white-space:nowrap}
  .mobile-back-btn{display:flex !important}
  .toolbar{display:none !important}

  .editor-content-wrap{padding:20px 20px 200px}
  .ed-title{font-size:26px;font-weight:700;margin-bottom:8px}
  .ed-body{font-size:16px;line-height:2.0;letter-spacing:0}
  .sf-row{flex-direction:column;gap:12px}

  /* 모바일 하단 글자수 */
  .ed-foot{padding:12px 20px;font-size:13px;gap:20px;background:var(--bg-white);border-top:1px solid var(--border)}
}
</style>
</head>
<body>

<div id="loadingScreen" class="hidden">
  <div class="loading-scene">
    <img src="gio_circle_white_closeup2_512.png" alt="지오" class="bounce-avatar">
    <div class="bounce-shadow"></div>
  </div>
  <div class="loading-text">불러오는 중</div>
</div>

<div id="lockScreen" class="hidden">
  <div class="lock-card">
    <div class="lock-brand">이름표 붙이기 게임</div>
    <div class="lock-desc">개인 기록 공간입니다. 로그인해주세요.</div>
    <div id="googleSignInBtn"></div>
    <div class="lock-err" id="lockErr"></div>
  </div>
</div>

<!-- 플로팅 인라인 툴바 -->
<div id="floatingToolbar">
  <button class="ft-btn" title="굵게" onclick="applyFormatFT('bold')"><b>B</b></button>
  <button class="ft-btn" title="기울임" onclick="applyFormatFT('italic')"><i style="font-style:italic">I</i></button>
  <button class="ft-btn highlight-btn" title="형광펜" onclick="applyHighlight()"><span class="hl-inner">A</span></button>
  <button class="ft-btn" title="취소선" onclick="applyFormatFT('strikeThrough')"><s>S</s></button>
  <button class="ft-btn" title="밑줄" onclick="applyFormatFT('underline')"><u>U</u></button>
</div>

<div class="app view-list" id="mainApp" style="display:none;">

<div class="side">
  <div class="header side-hdr">
    <div class="header-left brand-wrap">
      <img src="gio_circle_white_closeup2_512.png" alt="지오" class="cat-avatar avatar">
      <div class="brand">이름표 붙이기 게임</div>
    </div>
    <div class="sync-row">
      <div class="sync-status" onclick="SYNC.syncAll()">
        <span class="sync-dot" id="syncDot"></span>
        <span id="syncStatus">완료됨</span>
      </div>
      <button class="sync-btn" onclick="SYNC.syncAll()">↻</button>
    </div>
  </div>
  
  <div class="side-scroll">
    <div class="sec sec-border quote-section">
      <div class="sec-t">오늘의 어구</div>
      <div class="q-card quote-card" onclick="showRandomQuote()">
        <div class="quote-mark">"</div>
        <div class="quote-label" style="display:none;">오늘의 어구</div>
        <div class="q-content">
          <div class="q-text quote-text" id="quoteText">어구록에 문장을 추가해보세요</div>
          <div class="q-by quote-by" id="quoteBy"></div>
        </div>
      </div>
    </div>

    <div class="sec sec-border side-nav" style="padding:8px 16px 12px">
      <div class="sec-t" style="margin-bottom:4px">글쓰기</div>
      <div id="sideNav" class="writing-grid"></div>
    </div>

    <div class="sec sec-border">
      <div class="sec-t">데일리 루틴</div>
      <div class="chk-table" id="chkTable"></div>
    </div>
    
    <div class="sec" style="padding-bottom:40px;">
      <div class="sec-t" style="display:flex; justify-content:space-between; align-items:center;">
        기록
      </div>
      <div class="stats-wrap">
        <div class="stat-col">
          <div class="stat-label">오늘 쓴 글</div>
          <div class="stat-big" id="wToday">0</div>
          <div class="stat-sub">월간 <span id="wMonth">0</span></div>
        </div>
        <div class="stat-col">
          <div class="stat-label">읽은 책</div>
          <div class="stat-big" id="bToday">0</div>
          <div class="stat-sub">월간 <span id="bMonth">0</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="list-panel">
  <div class="lp-hdr">
    <button class="sb-toggle pc-sidebar-toggle" onclick="toggleSidebar()" title="사이드바 열기/닫기">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
    </button>
    <button class="sb-toggle mobile-nav-btn" onclick="setMobileView('side')" title="메뉴 열기">
      <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>

    <div class="view-switcher" id="viewSwitcher">
      <button class="vs-btn on" id="btn-list" onclick="switchListView('list')" title="목록">
        <svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
      </button>
      <button class="vs-btn" id="btn-photo" onclick="switchListView('photo')" title="사진">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      </button>
      <button class="vs-btn" id="btn-calendar" onclick="switchListView('calendar')" title="캘린더">
        <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      </button>
    </div>

    <div class="search-bar" id="searchBar">
      <button class="search-icon-btn lp-search-btn" onclick="toggleSearch()" title="검색">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </button>
      <input type="text" id="searchInput" placeholder="#태그 또는 검색어" oninput="handleSearch(event)">
      <button id="clearSearchBtn" onclick="clearSearch()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:12px;height:12px;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
    </div>
  </div>

  <div class="pane-list" id="pane-list"></div>
  
  <div class="pane-photo" id="pane-photo">
    <div class="photo-grid" id="photoGrid"></div>
  </div>

  <div class="pane-calendar" id="pane-calendar">
    <div class="cal-wrap" id="calWrap"></div>
  </div>
  
  <button class="fab-btn" onclick="handleNew()" title="새 글 작성">
    <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
  </button>
</div>

<div class="editor">
  <div class="col-header ed-topbar">
    <div class="ed-topbar-left">
      <button class="mobile-nav-btn mobile-back-btn" onclick="setMobileView('list')" title="목록으로 가기">
        <svg viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
      </button>
      <span class="ed-header-date" id="edDate"></span>
      <span class="ed-save-status" id="edSaveStatus">저장됨</span>
    </div>
    <div class="ed-topbar-right">
      <button class="ed-top-btn pc-only" onclick="handleNew()">+ 새 글</button>
      <button class="ed-btn-done" onclick="handleDone()">완료</button>
    </div>
  </div>
  
  <div class="toolbar" id="edToolbar">
    <!-- 제목 드롭다운 -->
    <div style="position:relative;flex-shrink:0;">
      <button class="tb-heading-btn" id="headingBtn" onclick="toggleHeadingMenu()">
        <svg viewBox="0 0 24 24"><text x="2" y="18" font-size="18" font-weight="900" fill="currentColor" stroke="none" font-family="serif">H</text></svg>
        <svg class="caret" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
      </button>
      <div class="heading-dropdown" id="headingDropdown">
        <div class="heading-opt" onclick="applyHeading('h1')">
          <span class="h-label h1">제목</span><span class="h-size">H1</span>
        </div>
        <div class="heading-opt" onclick="applyHeading('h2')">
          <span class="h-label h2">부제목</span><span class="h-size">H2</span>
        </div>
        <div class="heading-opt" onclick="applyHeading('h3')">
          <span class="h-label h3">소제목</span><span class="h-size">H3</span>
        </div>
      </div>
    </div>

    <div class="tb-sep"></div>

    <button class="tb-btn" title="순서 없는 목록" onclick="execCmd('insertUnorderedList')">
      <svg viewBox="0 0 24 24"><line x1="9" y1="6" x2="21" y2="6"/><line x1="9" y1="12" x2="21" y2="12"/><line x1="9" y1="18" x2="21" y2="18"/><circle cx="4" cy="6" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="12" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="18" r="1.5" fill="currentColor" stroke="none"/></svg>
    </button>
    <button class="tb-btn" title="순서 있는 목록" onclick="execCmd('insertOrderedList')">
      <svg viewBox="0 0 24 24"><line x1="10" y1="6" x2="21" y2="6"/><line x1="10" y1="12" x2="21" y2="12"/><line x1="10" y1="18" x2="21" y2="18"/><text x="2" y="9" font-size="8" font-family="sans-serif" stroke="none" fill="currentColor" font-weight="700">1.</text><text x="2" y="15" font-size="8" font-family="sans-serif" stroke="none" fill="currentColor" font-weight="700">2.</text><text x="2" y="21" font-size="8" font-family="sans-serif" stroke="none" fill="currentColor" font-weight="700">3.</text></svg>
    </button>
    <button class="tb-btn" title="체크리스트" onclick="insertChecklist()">
      <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
    </button>

    <div class="tb-sep"></div>

    <button class="tb-btn" title="인용" onclick="execCmd('formatBlock','blockquote')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"/></svg>
    </button>
    <button class="tb-btn" title="구분선" onclick="execCmd('insertHorizontalRule')">
      <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/></svg>
    </button>

    <div class="tb-sep"></div>

    <button class="tb-btn media" title="사진/동영상 업로드" onclick="document.getElementById('mediaInput').click()">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
    </button>
    <button class="tb-btn media" title="파일 첨부" onclick="document.getElementById('fileInput').click()">
      <svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
    </button>
    <input type="file" id="mediaInput" accept="image/*,video/*" style="display:none" onchange="handleMediaUpload(event)">
    <input type="file" id="fileInput" style="display:none" onchange="handleMediaUpload(event)">
  </div>
  
  <div id="editorText" style="display:flex;flex-direction:column;flex:1;overflow:hidden">
    <div class="editor-scroll-area">
      <div class="editor-content-wrap">
        <input class="ed-title" id="edTitle" placeholder="제목">
        <div class="ed-tags-wrap">
          <svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
          <input class="ed-tags" id="edTags" placeholder="태그 추가 (스페이스로 구분, 예: #일기 #아이디어)">
        </div>
        <div class="ed-body" id="edBody" contenteditable="true" spellcheck="false" translate="no" data-placeholder="여기에 글을 쓰세요... (이미지 복사+붙여넣기 가능)"></div>
      </div>
    </div>
    <div class="ed-foot"><span id="edChars">0자</span><span id="edWords">0단어</span><span id="edPages">0매</span></div>
  </div>
  
  <div id="editorBook" style="display:none;flex-direction:column;flex:1;overflow:hidden">
    <div class="editor-scroll-area">
      <div class="editor-content-wrap">
        <div class="special-form">
          <div class="sf-field"><span class="sf-label">제목</span><input class="sf-input" id="book-title" placeholder="책 제목"></div>
          <div class="sf-row"><div class="sf-field" style="flex:2"><span class="sf-label">저자</span><input class="sf-input" id="book-author" placeholder="저자명"></div><div class="sf-field" style="flex:2"><span class="sf-label">출판사</span><input class="sf-input" id="book-publisher" placeholder="출판사명"></div><div class="sf-field" style="flex:1"><span class="sf-label">읽은 양 (p)</span><input class="sf-input" id="book-pages" placeholder="숫자만" type="number"></div></div>
        </div>
        <div class="ed-body" id="book-body" contenteditable="true" spellcheck="false" translate="no" data-placeholder="책에 대한 메모..."></div>
      </div>
    </div>
  </div>

  <div id="editorQuote" style="display:none;flex-direction:column;flex:1;overflow:hidden">
    <div class="editor-scroll-area">
      <div class="editor-content-wrap">
        <div class="special-form"><div class="sf-field"><span class="sf-label">출처</span><input class="sf-input" id="quote-by" placeholder="책 제목, 저자 등"></div></div>
        <div class="ed-body" id="quote-body" contenteditable="true" spellcheck="false" translate="no" data-placeholder="인상 깊은 문장을 기록하세요..."></div>
      </div>
    </div>
  </div>

  <div id="editorMemo" style="display:none;flex-direction:column;flex:1;overflow:hidden">
    <div class="editor-scroll-area">
      <div class="editor-content-wrap">
        <input class="ed-title" id="memo-title" placeholder="메모 제목">
        <div class="ed-tags-wrap">
          <svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
          <input class="ed-tags" id="memoTags" placeholder="태그 추가 (스페이스로 구분, 예: #회의 #자료)">
        </div>
        <div class="ed-body" id="memo-body" contenteditable="true" spellcheck="false" translate="no" data-placeholder="메모를 작성하세요... (이미지 복사+붙여넣기 가능)"></div>
      </div>
    </div>
  </div>

</div>

<script>
// ═══ GOOGLE AUTH ═══
const GOOGLE_CLIENT_ID = "910366325974-3ollm3pose37r1fvv8ngnd0v09f2p57l.apps.googleusercontent.com"; 
const ALLOWED_EMAIL = "leftjap@gmail.com";

function handleCredentialResponse(response) {
  try {
    const jwt = response.credential;
    const payload = JSON.parse(atob(jwt.split('.')[1]));
    
    if (payload.email === ALLOWED_EMAIL) {
      localStorage.setItem('gb_auth', '1');
      localStorage.setItem('gb_id_token', jwt);
      document.getElementById('lockScreen').classList.add('hidden');
      showApp();
    } else {
      document.getElementById('lockErr').textContent = '접근 권한이 없는 계정입니다.';
    }
  } catch (e) {
    document.getElementById('lockErr').textContent = '로그인 처리 중 오류가 발생했습니다.';
  }
}

window.onload = function () {
  document.getElementById('lockScreen').classList.add('hidden');
  showApp();
};

async function showApp(){
  const loading = document.getElementById('loadingScreen');
  loading.classList.remove('hidden');

  SYNC.setSyncStatus('동기화 중', 'syncing');
  await SYNC.loadDatabase();
  
  injectMockData(); 
  
  init();

  loading.style.opacity = '0';
  setTimeout(() => {
    loading.classList.add('hidden');
    loading.style.opacity = '';
    document.getElementById('mainApp').style.display='flex';
    if(window.innerWidth <= 768) setMobileView('side');
  }, 400);
}

// ═══ Storage ═══
const APP_TOKEN='nametag2026';
const K={docs:'gb_docs',checks:'gb_chk',books:'gb_books',quotes:'gb_quotes',memos:'gb_memos'};
const L=k=>{try{return JSON.parse(localStorage.getItem(k))||null}catch{return null}};
const S=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

// 검색 및 태그 시안용 더미 데이터 생성 함수
function injectMockData() {
    if(L(K.docs) && L(K.docs).length > 0) return;
    
    const docs = [
        { id: 'm1', type: 'blog', title: '바이브 코딩 체험기', tags: '#AI #개발 #에세이', content: '바이브 코딩은 처음 해보는데 그야말로 신세계다.<br><br>말로 이렇게 저렇게 구현됐으면 좋겠다고 말하면 AI가 뚝딱 결과물을 내놓는다. 불과 몇 년 전만 하더라도 이런 웹사이트 하나 만들려고 하면 기획자/개발자/디자이너 등 여러 명이 붙어야 했다. 지금은 내가 기획만 하면 나머지는 알아서 처리해 준다.', created: new Date(Date.now() - 86400000).toISOString(), updated: new Date().toISOString(), pinned: false }
    ];
    S(K.docs, docs);

    const memos = [
        { id: 'mem1', title: '제천음악영화제 시청 기록', tags: '#영화 #장항준 #인사이트', content: '영화 &lt;왕의 남자&gt;가 흥행하면서 관련 콘텐츠가 많이 올라온다. 장항준 감독은 지난 제천음악영화제 집행위원장을 맡게 되었는데 개막식 브이로그가 꽤나 인상적이다.<br><br>"영화제 집행위원장은 처음이신데 긴장되진 않으세요?"<br><br>"지금 개막식 2시간 전인데... 하지만 긴장하면 지고 설레면 이긴다 이렇게 생각합니다."', created: new Date().toISOString(), updated: new Date().toISOString(), pinned: true }
    ];
    S(K.memos, memos);

    const quotes = [
        { id: 'q1', text: '긴장하면 지고 설레면 이긴다.', by: '장항준', created: new Date().toISOString(), pinned: false }
    ];
    S(K.quotes, quotes);
}

const getLocalYMD=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const today=()=>getLocalYMD(new Date());
const weekdays=['일','월','화','수','목','금','토'];

const formatFullDate = iso => {
  if(!iso) return '';
  const d = new Date(iso);
  let h = d.getHours(), m = d.getMinutes(), ampm = h >= 12 ? '오후' : '오전';
  h = h % 12 || 12;
  return `${d.getFullYear()}년 ${d.getMonth()+1}월 ${d.getDate()}일 (${weekdays[d.getDay()]}) ${ampm} ${h}:${String(m).padStart(2,'0')}`;
};

const formatTimeOnly = iso => {
  if(!iso) return '';
  const d = new Date(iso);
  let h = d.getHours(), m = d.getMinutes(), ampm = h >= 12 ? '오후' : '오전';
  h = h % 12 || 12;
  return `${ampm} ${h}:${String(m).padStart(2,'0')}`;
}

const getMonthYearStr = iso => {
  if(!iso) return '';
  const d = new Date(iso);
  return `${d.getFullYear()}년 ${d.getMonth()+1}월`;
}

function getWeekDates(){
  const d=new Date(),day=d.getDay(),sun=new Date(d);
  sun.setDate(d.getDate()-day);
  return Array.from({length:7},(_,i)=>{
    const x=new Date(sun);
    x.setDate(sun.getDate()+i);
    return getLocalYMD(x);
  });
}

const stripHtml=s=>(s||'').replace(/<[^>]*>/g,'').replace(/&nbsp;/g,' ');
const formatTopDate = iso => formatFullDate(iso);
function fixDriveImageUrls(html) {
  if(!html) return '';
  return html.replace(/https:\/\/drive\.google\.com\/uc\?export=view(&amp;|&)id=([a-zA-Z0-9_-]+)/g, 'https://drive.google.com/thumbnail?id=$2&sz=w1000');
}

// ═══ State, Search & Mobile View ═══
let activeTab='navi';
const textTypes=['navi','fiction','blog'];
const TAB_META={navi:'오늘의 네비',fiction:'단편 습작',blog:'블로그',book:'서재',quote:'어구',memo:'메모'};
const curIds={};
let curQuoteId = null;
let curBookId=null;
let curMemoId=null;
let currentLoadedDoc = { type: null, id: null };
let currentSearchQuery = '';
let currentListView = 'list';

function switchListView(view) {
  currentListView = view;
  ['list', 'photo', 'calendar'].forEach(v => {
    document.getElementById('pane-' + v).style.display = 'none';
    document.getElementById('btn-' + v).classList.remove('on');
  });
  const target = document.getElementById('pane-' + view);
  target.style.display = (view === 'list') ? 'flex' : 'block';
  document.getElementById('btn-' + view).classList.add('on');
  
  renderListPanel();
}

function toggleSidebar() {
  const app = document.getElementById('mainApp');
  app.classList.toggle('sidebar-closed');
  localStorage.setItem('gb_sidebar_closed', app.classList.contains('sidebar-closed') ? '1' : '0');
}

function setMobileView(view) {
  const app = document.getElementById('mainApp');
  app.classList.remove('view-side', 'view-list', 'view-editor');
  app.classList.add('view-' + view);
  if(view === 'list') renderListPanel();
}

function toggleSearch() {
  const bar = document.getElementById('searchBar');
  const input = document.getElementById('searchInput');
  const vs = document.getElementById('viewSwitcher');
  
  bar.classList.toggle('active');
  if(bar.classList.contains('active')) {
    vs.style.display = 'none'; // 작은 모바일에서 아이콘 안 겹치게 숨김 처리
    input.focus();
  } else {
    clearSearch();
  }
}

function handleSearch(e) {
  currentSearchQuery = e.target.value.trim();
  document.getElementById('clearSearchBtn').style.display = currentSearchQuery ? 'flex' : 'none';
  renderListPanel();
}

function clearSearch() {
  const input = document.getElementById('searchInput');
  input.value = '';
  currentSearchQuery = '';
  document.getElementById('clearSearchBtn').style.display = 'none';
  document.getElementById('searchBar').classList.remove('active');
  document.getElementById('viewSwitcher').style.display = 'flex';
  renderListPanel();
}

function setTagSearch(tag) {
  const bar = document.getElementById('searchBar');
  const input = document.getElementById('searchInput');
  const vs = document.getElementById('viewSwitcher');
  
  bar.classList.add('active');
  vs.style.display = 'none';
  input.value = tag;
  currentSearchQuery = tag;
  document.getElementById('clearSearchBtn').style.display = 'flex';
  if(window.innerWidth <= 768) setMobileView('list');
  renderListPanel();
}

// ═══ Checks (Routine) ═══
const ROUTINE_META = [
  { id: 'exercise', name: '운동', color: '#e87461', bg: '#fdf1ef' },
  { id: 'vitamin', name: '영양제', color: '#f0a848', bg: '#fef6eb' },
  { id: 'english', name: '영어', color: '#5a8ec4', bg: '#eff3f9' },
  { id: 'japanese', name: '일본어', color: '#7cb87c', bg: '#f2f8f2' },
  { id: 'drawing', name: '드로잉', color: '#9a6cb8', bg: '#f5f0f8' },
  { id: 'ukulele', name: '우쿨렐레', color: '#d4789a', bg: '#fbf1f5' },
  { id: 'nodrink', name: '금주', color: '#6ab0a0', bg: '#f0f7f5' }
];

function getChk(){return(L(K.checks)||{})[today()]||{}}
function saveChk(id,v){const d=L(K.checks)||{};if(!d[today()])d[today()]={};d[today()][id]=v;S(K.checks,d)}
function getAllChk(){return L(K.checks)||{}}

function renderChk(){
  const chk=getChk(), all=getAllChk(), week=getWeekDates(), td=today();
  const container=document.getElementById('chkTable');
  const mob=window.innerWidth<=768;

  const W = mob ? Math.max(200, window.innerWidth - 68) : 240;
  const H = mob ? 48 : 52;

  function circleRectArea(cx, cy, r) {
    const steps = 200;
    const dy = H / steps;
    let area = 0;
    for (let i = 0; i < steps; i++) {
      const y = (i + 0.5) * dy;
      const d2 = r * r - (y - cy) * (y - cy);
      if (d2 <= 0) continue;
      const hw = Math.sqrt(d2);
      const x0 = Math.max(0, cx - hw);
      const x1 = Math.min(W, cx + hw);
      if (x1 > x0) area += (x1 - x0) * dy;
    }
    return area;
  }

  function findRadius(cx, cy, targetArea) {
    let lo = 0, hi = W * 3;
    for (let i = 0; i < 60; i++) {
      const mid = (lo + hi) / 2;
      if (circleRectArea(cx, cy, mid) < targetArea) lo = mid;
      else hi = mid;
    }
    return (lo + hi) / 2;
  }

  const CENTER_MAP = {
    1: { cx: -15,      cy: -8     },
    2: { cx: 0,        cy: H      },
    3: { cx: 0,        cy: H/2    },
    4: { cx: W * 0.15, cy: 0      },
    5: { cx: -10,      cy: 0      },
    6: { cx: 0,        cy: H*0.3  },
  };

  let h = '';
  const dayN = ['일','월','화','수','목','금','토'];
  h += '<div class="chk-week-hdr">'
    + '<div class="chk-week-hdr-spacer"></div>'
    + '<div class="day-labels">'
    + dayN.map(d => '<span class="day-lbl">' + d + '</span>').join('')
    + '</div></div>';

  ROUTINE_META.forEach(r => {
    const weekDone = week.map(dt => all[dt] && all[dt][r.id] ? 1 : 0);
    const doneCount = weekDone.filter(d => d).length;
    const pct = Math.round((doneCount / 7) * 100);
    const target = (doneCount === 1) ? (1.7 / 7) * W * H : (doneCount / 7) * W * H;

    let blobHtml = '';
    if (doneCount === 7) {
      const bigR = 999;
      blobHtml = '<div class="chk-blob" style="background:' + r.color
        + ';width:' + (bigR*2) + 'px;height:' + (bigR*2) + 'px'
        + ';left:' + (-bigR) + 'px;top:' + (H/2-bigR) + 'px;"></div>';
    } else if (doneCount > 0) {
      const { cx, cy } = CENTER_MAP[doneCount];
      const rr = findRadius(cx, cy, target);
      blobHtml = '<div class="chk-blob" style="background:' + r.color
        + ';width:' + (rr*2) + 'px;height:' + (rr*2) + 'px'
        + ';left:' + (cx-rr) + 'px;top:' + (cy-rr) + 'px;"></div>';
    }

    const dotHtml = weekDone.map((done, i) => {
      const dt = week[i];
      const isTd = dt === td;
      return '<div class="chk-dot ' + (done ? 'done' : '') + ' ' + (isTd ? 'today' : '')
        + '" onclick="event.stopPropagation();toggleDay(\'' + r.id + '\',\'' + dt + '\')"></div>';
    }).join('');

    h += '<div class="chk-row" onclick="toggleChk(\'' + r.id + '\')">'
      + blobHtml
      + (doneCount > 0 ? '<span class="chk-pct">' + pct + '%</span>' : '')
      + '<div class="chk-left"><span class="chk-lb">' + r.name + '</span></div>'
      + '<div class="chk-dots">' + dotHtml + '</div>'
      + '</div>';
  });

  container.innerHTML = h;
}

let _chkT=null;
function toggleChk(id) { toggleDay(id, today()); }
function toggleDay(id, dateStr) {
  const d = L(K.checks) || {};
  if(!d[dateStr]) d[dateStr] = {};
  d[dateStr][id] = !d[dateStr][id];
  S(K.checks, d);
  renderChk();
  clearTimeout(_chkT); 
  _chkT=setTimeout(()=>{ SYNC.saveChecksToSheet(dateStr, d[dateStr]); SYNC.scheduleDatabaseSave(); },1200);
}

// ═══ Documents ═══
function allDocs(){return L(K.docs)||[]}
function getDocs(type){return allDocs().filter(d=>d.type===type)}
function saveDocs(docs){S(K.docs,docs)}

function newDoc(type){
  const doc={id:Date.now().toString(), driveId: null, type,title:'', tags:'', content:'',created:new Date().toISOString(),updated:new Date().toISOString(),pinned:false};
  const docs=allDocs();docs.unshift(doc);saveDocs(docs);
  return doc;
}

function loadDoc(type, id, force=false){
  const doc=allDocs().find(d=>d.id===id);if(!doc)return;
  if(!force && currentLoadedDoc.type === type && currentLoadedDoc.id === id) return;
  
  curIds[type]=id;
  currentLoadedDoc = { type, id };
  document.getElementById('edTitle').value=doc.title;
  document.getElementById('edTags').value=doc.tags || '';
  document.getElementById('edBody').innerHTML=fixDriveImageUrls(doc.content);
  document.getElementById('edDate').textContent=formatTopDate(doc.created);
  updateWC();
  renderListPanel(); 
}

function saveCurDoc(type){
  if(!curIds[type])return;
  const title=document.getElementById('edTitle').value.trim();
  const tags=document.getElementById('edTags').value.trim();
  const content=document.getElementById('edBody').innerHTML;
  const docs=allDocs();const idx=docs.findIndex(d=>d.id===curIds[type]);
  if(idx!==-1){
    docs[idx].title=title;
    docs[idx].tags=tags;
    docs[idx].content=content;
    docs[idx].updated=new Date().toISOString();
    saveDocs(docs);
  }
}

function delDoc(type,id,e){
  e.stopPropagation();if(!confirm('삭제할까요?'))return;
  saveDocs(allDocs().filter(d=>d.id!==id));
  if(curIds[type]===id) { curIds[type]=null; currentLoadedDoc = { type:null, id:null }; }
  renderListPanel();
  SYNC.scheduleDatabaseSave();
  const docs=getDocs(type);
  if(docs.length) loadDoc(type,docs[0].id, true);
  else { const nd=newDoc(type); loadDoc(type,nd.id, true); }
}

function updateWC(){
  const t = document.getElementById('edBody').textContent.trim();
  const c = t.replace(/\s/g,'').length;
  const w = t.split(/\s+/).filter(x=>x).length;
  if(document.getElementById('edChars')) document.getElementById('edChars').textContent = c.toLocaleString()+'자';
  if(document.getElementById('edWords')) document.getElementById('edWords').textContent = w.toLocaleString()+'단어';
  if(document.getElementById('edPages')) document.getElementById('edPages').textContent = (c/200).toFixed(1)+'매';
  updateWritingStats();
}

// ═══ Books ═══
function getBooks(){return L(K.books)||[]}
function saveBooks(b){S(K.books,b)}
function newBook(){
  curBookId=null;
  currentLoadedDoc = { type: 'book', id: null };
  document.getElementById('book-title').value='';
  document.getElementById('book-author').value='';
  document.getElementById('book-publisher').value='';
  document.getElementById('book-pages').value='';
  document.getElementById('book-body').innerHTML='';
  document.getElementById('edDate').textContent=formatTopDate(new Date().toISOString());
}
function saveBook(){
  const title=document.getElementById('book-title').value.trim();
  if(!title)return; 
  const b={id:curBookId||Date.now().toString(), driveId: null, title,author:document.getElementById('book-author').value.trim(),publisher:document.getElementById('book-publisher').value.trim(),pages:parseInt(document.getElementById('book-pages').value)||0,memo:document.getElementById('book-body').innerHTML,date:today(),pinned:false};
  const books=getBooks();
  if(curBookId){
    const idx=books.findIndex(x=>x.id===curBookId);
    if(idx!==-1){ b.pinned = books[idx].pinned; b.driveId = books[idx].driveId; books[idx]=b; }
  } else {
    books.unshift(b);
  }
  curBookId=b.id;
  saveBooks(books);
  updateBookStats();
  SYNC.scheduleBookSave(b);
}
function loadBook(id, force=false){
  const b=getBooks().find(x=>x.id===id);if(!b)return;
  if(!force && currentLoadedDoc.type === 'book' && currentLoadedDoc.id === id) return;
  curBookId=id;
  currentLoadedDoc = { type: 'book', id };
  document.getElementById('book-title').value=b.title;
  document.getElementById('book-author').value=b.author||'';
  document.getElementById('book-publisher').value=b.publisher||'';
  document.getElementById('book-pages').value=b.pages||'';
  document.getElementById('book-body').innerHTML=b.memo||'';
  document.getElementById('edDate').textContent=formatTopDate(b.date ? new Date(b.date).toISOString() : new Date().toISOString());
}
function delBook(id,e){
  e.stopPropagation();if(!confirm('삭제할까요?'))return;
  saveBooks(getBooks().filter(b=>b.id!==id));
  if(curBookId===id) { curBookId=null; currentLoadedDoc = { type:null, id:null }; }
  renderListPanel();
  updateBookStats();
  SYNC.scheduleDatabaseSave();
}
function updateBookStats(){
  const books=getBooks();
  const td=today(), tm=td.slice(0,7), ty=td.slice(0,4);
  let pT=0, pM=0, pY=0;
  books.forEach(b=>{
    const p=parseInt(b.pages)||0;
    const d=b.date; 
    if(!d) return;
    if(d===td) pT+=p;
    if(d.startsWith(tm)) pM+=p;
    if(d.startsWith(ty)) pY+=p;
  });
  if(document.getElementById('bToday')) document.getElementById('bToday').innerHTML=pT+`<span class='unit'>p</span>`;
  if(document.getElementById('bMonth')) document.getElementById('bMonth').textContent=pM+'p';
  if(document.getElementById('bYear')) document.getElementById('bYear').textContent=pY+'p';
}

// ═══ Quotes ═══
function getQuotes(){return L(K.quotes)||[]}
function saveQuotes(q){S(K.quotes,q)}
function saveQuote(){
  const text=document.getElementById('quote-body').innerText.trim();
  if(!text)return;
  const by=document.getElementById('quote-by').value.trim();
  const quotes=getQuotes();
  if(curQuoteId) {
    const idx=quotes.findIndex(q=>q.id===curQuoteId);
    if(idx!==-1){ quotes[idx].text=text; quotes[idx].by=by; }
  } else {
    const q={id:Date.now().toString(),text,by,created:new Date().toISOString(),pinned:false};
    quotes.unshift(q);
    curQuoteId=q.id;
  }
  saveQuotes(quotes);
  SYNC.scheduleQuoteSave(text, by, curQuoteId);
}
function newQuoteForm(){
  curQuoteId=null;
  currentLoadedDoc = { type: 'quote', id: null };
  document.getElementById('quote-body').innerHTML='';
  document.getElementById('quote-by').value='';
  document.getElementById('edDate').textContent=formatTopDate(new Date().toISOString());
}
function loadQuote(id, force=false){
  const q=getQuotes().find(x=>x.id===id);if(!q)return;
  if(!force && currentLoadedDoc.type === 'quote' && currentLoadedDoc.id === id) return;
  curQuoteId=id;
  currentLoadedDoc = { type: 'quote', id };
  document.getElementById('quote-body').innerText=q.text;
  document.getElementById('quote-by').value=q.by||'';
  document.getElementById('edDate').textContent=formatTopDate(q.created);
}
function delQuote(id,e){
  e.stopPropagation();if(!confirm('삭제할까요?'))return;
  saveQuotes(getQuotes().filter(q=>q.id!==id));
  if(curQuoteId===id) { curQuoteId=null; currentLoadedDoc = { type:null, id:null }; }
  renderListPanel();
  showRandomQuote();
  SYNC.scheduleDatabaseSave();
}
function showRandomQuote(){
  const quotes=getQuotes();
  if(!quotes.length){
    if(document.getElementById('quoteText')) document.getElementById('quoteText').textContent='어구록에 문장을 추가해보세요';
    if(document.getElementById('quoteBy')) document.getElementById('quoteBy').textContent='';
    return;
  }
  const q=quotes[Math.floor(Math.random()*quotes.length)];
  if(document.getElementById('quoteText')) document.getElementById('quoteText').textContent=q.text.length>80?q.text.slice(0,80)+'…':q.text;
  if(document.getElementById('quoteBy')) document.getElementById('quoteBy').textContent=q.by?'— '+q.by:'';
}

// ═══ Memos ═══
function getMemos(){return L(K.memos)||[]}
function saveMemos(m){S(K.memos,m)}
function saveMemo(){
  const title=document.getElementById('memo-title').value.trim();
  const tags=document.getElementById('memoTags').value.trim();
  const body=document.getElementById('memo-body').innerHTML;
  if(!title&&!stripHtml(body).trim())return;
  const memos=getMemos();
  if(curMemoId){
    const idx=memos.findIndex(m=>m.id===curMemoId);
    if(idx!==-1){memos[idx].title=title;memos[idx].tags=tags;memos[idx].content=body;memos[idx].updated=new Date().toISOString()}
  }else{
    const memo={id:Date.now().toString(), driveId: null, title,tags,content:body,created:new Date().toISOString(),updated:new Date().toISOString(),pinned:false};
    memos.unshift(memo);curMemoId=memo.id;
  }
  saveMemos(memos);
  SYNC.scheduleDocSave('memo');
}
function loadMemo(id, force=false){
  const m=getMemos().find(x=>x.id===id);if(!m)return;
  if(!force && currentLoadedDoc.type === 'memo' && currentLoadedDoc.id === id) return;
  curMemoId=id;
  currentLoadedDoc = { type: 'memo', id };
  document.getElementById('memo-title').value=m.title||'';
  document.getElementById('memoTags').value=m.tags||'';
  document.getElementById('memo-body').innerHTML=fixDriveImageUrls(m.content);
  document.getElementById('edDate').textContent=formatTopDate(m.created);
}
function newMemoForm(){
  curMemoId=null;
  currentLoadedDoc = { type: 'memo', id: null };
  document.getElementById('memo-title').value='';
  document.getElementById('memoTags').value='';
  document.getElementById('memo-body').innerHTML='';
  document.getElementById('edDate').textContent=formatTopDate(new Date().toISOString());
}
function delMemo(id,e){
  e.stopPropagation();if(!confirm('삭제할까요?'))return;
  saveMemos(getMemos().filter(m=>m.id!==id));
  if(curMemoId===id) { curMemoId=null; currentLoadedDoc = { type:null, id:null }; }
  renderListPanel();
  SYNC.scheduleDatabaseSave();
}

// ═══ Stats ═══
function getTabCount(t){
  if(textTypes.includes(t))return getDocs(t).length;
  if(t==='book')return (L(K.books)||[]).length;
  if(t==='quote')return (L(K.quotes)||[]).length;
  if(t==='memo')return (L(K.memos)||[]).length;
  return 0;
}

function updateWritingStats(){
  const docs=allDocs().filter(d=>d.type==='fiction');
  const td=today(), tm=td.slice(0,7), ty=td.slice(0,4);
  let tT=0, tM=0, tY=0;
  docs.forEach(d=>{
    const c=stripHtml(d.content).replace(/\s/g,'').length;
    const dt=d.updated?.slice(0,10)||d.created?.slice(0,10);
    if(!dt) return;
    if(dt===td) tT+=c;
    if(dt.startsWith(tm)) tM+=c;
    if(dt.startsWith(ty)) tY+=c;
  });
  if(document.getElementById('wToday')) document.getElementById('wToday').innerHTML=(tT/200).toFixed(1)+`<span class='unit'>매</span>`;
  if(document.getElementById('wMonth')) document.getElementById('wMonth').textContent=(tM/200).toFixed(1)+'매';
}

function renderWritingGrid() {
  const nav = document.getElementById('sideNav');
  if(!nav) return;
  const tabs = [
    { id: 'navi', label: '오늘의 네비' },
    { id: 'fiction', label: '단편 습작' },
    { id: 'blog', label: '블로그' },
    { id: 'book', label: '서재' },
    { id: 'quote', label: '어구' },
    { id: 'memo', label: '메모' }
  ];
  let html = '';
  if (window.innerWidth <= 768) {
    tabs.forEach(t => {
      html += `
        <div class="side-menu ${activeTab===t.id?'on':''}" data-tab="${t.id}" onclick="switchTab('${t.id}'); setMobileView('list');">
          <div class="side-menu-l">${t.label}</div>
          <div class="badge-pill">${getTabCount(t.id)}</div>
          <div class="wi-arrow">›</div>
        </div>
      `;
    });
  } else {
    tabs.forEach(t => {
      html += `
        <button class="side-menu ${activeTab===t.id?'on':''}" onclick="switchTab('${t.id}'); setMobileView('list');">
          <span class="side-menu-l">${t.label}</span>
          <span class="badge-pill">${getTabCount(t.id)}</span>
        </button>
      `;
    });
  }
  nav.innerHTML = html;
}

window.addEventListener('resize', () => { renderWritingGrid(); renderChk(); });

function togglePin(type, id, e) {
  e.stopPropagation();
  let items = type === 'memo' ? (L(K.memos)||[]) : type === 'book' ? (L(K.books)||[]) : type === 'quote' ? (L(K.quotes)||[]) : allDocs();
  const idx = items.findIndex(x => x.id === id);
  if (idx !== -1) { items[idx].pinned = !items[idx].pinned; }
  if (type === 'memo') S(K.memos, items); else if (type === 'book') S(K.books, items); else if (type === 'quote') S(K.quotes, items); else S(K.docs, items);
  renderListPanel();
  SYNC.scheduleDatabaseSave();
}

// ═══ Tab Switch ═══
function switchTab(t){
  if(textTypes.includes(activeTab))saveCurDoc(activeTab);
  activeTab=t;
  
  document.getElementById('editorText').style.display=textTypes.includes(t)?'flex':'none';
  document.getElementById('editorBook').style.display=t==='book'?'flex':'none';
  document.getElementById('editorQuote').style.display=t==='quote'?'flex':'none';
  document.getElementById('editorMemo').style.display=t==='memo'?'flex':'none';
  document.getElementById('edToolbar').style.display=['book','quote'].includes(t)?'none':'flex';
  
  clearSearch(); 
  switchListView('list');

  if(textTypes.includes(t)){
    const docs=getDocs(t);
    if(curIds[t]) loadDoc(t,curIds[t], true);
    else if(docs.length) loadDoc(t,docs[0].id, true);
    else {const nd=newDoc(t);loadDoc(t,nd.id, true);}
  }
  if(t==='book'){if(curBookId)loadBook(curBookId, true);else{const b=getBooks();if(b.length)loadBook(b[0].id, true);else newBook()}}
  if(t==='memo'){if(curMemoId)loadMemo(curMemoId, true);else{const m=getMemos();if(m.length)loadMemo(m[0].id, true);else newMemoForm()}}
  if(t==='quote'){newQuoteForm();}
  renderListPanel();
}

// ═══ List Panel & Sub Views (PC & Mobile) ═══

function getThumb(content) {
  if(!content) return '';
  const m = content.match(/<img[^>]+src=["'](data:image[^"']+|https?:[^"']+)["'][^>]*>/i);
  return m ? m[1] : '';
}

const hl = (txt) => {
  if (!txt || !currentSearchQuery) return txt || '';
  const safeQuery = currentSearchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const regex = new RegExp(`(${safeQuery})`, 'gi');
  return String(txt).replace(regex, '<mark class="highlight">$1</mark>');
};

const getPreviewText = (htmlContent) => {
  let raw = stripHtml(htmlContent) || '';
  if(!currentSearchQuery) return raw.slice(0,80);
  const idx = raw.toLowerCase().indexOf(currentSearchQuery.toLowerCase());
  if(idx !== -1) {
    const start = Math.max(0, idx - 30);
    const end = Math.min(raw.length, idx + currentSearchQuery.length + 30);
    return (start > 0 ? '...' : '') + raw.substring(start, end) + (end < raw.length ? '...' : '');
  }
  return raw.slice(0, 80);
};

function generateItemHtml(item, t) {
  const dt = new Date(item.created || item.date || Date.now());
  const day = dt.getDate();
  const dow = weekdays[dt.getDay()];
  const time = formatTimeOnly(item.created || item.date);
  
  const swipePin = (fn) => `<div class="swipe-action pin-action" onclick="event.stopPropagation();${fn}"><span><svg viewBox="0 0 24 24"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.68V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3v4.68a2 2 0 0 1-1.11 1.87l-1.78.9A2 2 0 0 0 5 15.24Z"></path></svg>고정</span></div>`;
  const swipeDel = (fn) => `<div class="swipe-action del-action" onclick="event.stopPropagation();${fn}"><span><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>삭제</span></div>`;
  
  const dateBlock = `<div class="lp-date-wrap"><div class="lp-dow">${dow}</div><div class="lp-day">${day}</div></div>`;
  
  let isCur = false;
  let clickFn = '';
  
  if(textTypes.includes(t)) {
    isCur = curIds[t]===item.id;
    clickFn = `loadDoc('${t}','${item.id}'); setMobileView('editor');`;
    const rawPreview = getPreviewText(item.content);
    const preview = hl(rawPreview);
    const thumb = getThumb(item.content);
    const thumbHtml = thumb ? `<div class="lp-thumb"><img src="${thumb}" alt="" style="width:100%;height:100%;object-fit:cover;"></div>` : '';
    const tagHtml = item.tags ? `<div class="lp-item-tags">${hl(item.tags)}</div>` : '';
    return `
    <div class="lp-item ${isCur?'on':''}" onclick="${clickFn}">
      ${dateBlock}
      <div class="lp-text-wrap">
        <div class="lp-item-title">${hl(item.title||'제목 없음')}</div>
        ${tagHtml}
        ${preview ? `<div class="lp-item-preview">${preview}</div>` : ''}
        <div class="lp-item-meta">${item.pinned?'📌 ':''}${time}</div>
      </div>
      ${thumbHtml}
      <div class="lp-item-actions">
        <button class="lp-action-btn pin ${item.pinned?'on':''}" onclick="togglePin('${t}','${item.id}',event)"><svg viewBox="0 0 24 24"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.68V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3v4.68a2 2 0 0 1-1.11 1.87l-1.78.9A2 2 0 0 0 5 15.24Z"></path></svg></button>
        <button class="lp-action-btn del" onclick="delDoc('${t}','${item.id}',event)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
      </div>
      <div class="swipe-actions">${swipePin(`togglePin('${t}','${item.id}',event)`)}${swipeDel(`delDoc('${t}','${item.id}',event)`)}</div>
    </div>`;
  } 
  else if(t==='book') {
    isCur = curBookId===item.id;
    clickFn = `loadBook('${item.id}'); setMobileView('editor');`;
    const authorPub = [item.author, item.publisher].filter(Boolean).join(' · ');
    return `
    <div class="lp-item ${isCur?'on':''}" onclick="${clickFn}">
      ${dateBlock}
      <div class="lp-text-wrap">
        <div class="lp-item-title">${hl(item.title)}</div>
        <div class="lp-item-preview">${hl(authorPub)}</div>
        <div class="lp-item-meta">${item.pinned?'📌 ':''}${time}</div>
      </div>
      <div class="lp-item-actions">
        <button class="lp-action-btn pin ${item.pinned?'on':''}" onclick="togglePin('${t}','${item.id}',event)"><svg viewBox="0 0 24 24"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.68V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3v4.68a2 2 0 0 1-1.11 1.87l-1.78.9A2 2 0 0 0 5 15.24Z"></path></svg></button>
        <button class="lp-action-btn del" onclick="delBook('${item.id}',event)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
      </div>
      <div class="swipe-actions">${swipePin(`togglePin('${t}','${item.id}',event)`)}${swipeDel(`delBook('${item.id}',event)`)}</div>
    </div>`;
  } 
  else if(t==='quote') {
    isCur = curQuoteId===item.id;
    clickFn = `loadQuote('${item.id}'); setMobileView('editor');`;
    return `
    <div class="lp-item ${isCur?'on':''}" onclick="${clickFn}">
      ${dateBlock}
      <div class="lp-text-wrap">
        <div class="quote-txt">${hl(item.text)}</div>
        ${item.by ? `<div class="lp-item-meta" style="margin-top:4px;">${item.pinned?'📌 ':''}${hl(item.by)}</div>` : ''}
      </div>
      <div class="lp-item-actions">
        <button class="lp-action-btn pin ${item.pinned?'on':''}" onclick="togglePin('${t}','${item.id}',event)"><svg viewBox="0 0 24 24"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.68V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3v4.68a2 2 0 0 1-1.11 1.87l-1.78.9A2 2 0 0 0 5 15.24Z"></path></svg></button>
        <button class="lp-action-btn del" onclick="delQuote('${item.id}',event)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
      </div>
      <div class="swipe-actions">${swipePin(`togglePin('${t}','${item.id}',event)`)}${swipeDel(`delQuote('${item.id}',event)`)}</div>
    </div>`;
  } 
  else if(t==='memo') {
    isCur = curMemoId===item.id;
    clickFn = `loadMemo('${item.id}'); setMobileView('editor');`;
    const rawPreview = getPreviewText(item.content);
    const preview = hl(rawPreview);
    const thumb = getThumb(item.content);
    const thumbHtml = thumb ? `<div class="lp-thumb"><img src="${thumb}" alt="" style="width:100%;height:100%;object-fit:cover;"></div>` : '';
    const tagHtml = item.tags ? `<div class="lp-item-tags">${hl(item.tags)}</div>` : '';
    return `
    <div class="lp-item ${isCur?'on':''}" onclick="${clickFn}">
      ${dateBlock}
      <div class="lp-text-wrap">
        <div class="lp-item-title">${hl(item.title||'제목 없음')}</div>
        ${tagHtml}
        ${preview ? `<div class="lp-item-preview">${preview}</div>` : ''}
        <div class="lp-item-meta">${item.pinned?'📌 ':''}${time}</div>
      </div>
      ${thumbHtml}
      <div class="lp-item-actions">
        <button class="lp-action-btn pin ${item.pinned?'on':''}" onclick="togglePin('${t}','${item.id}',event)"><svg viewBox="0 0 24 24"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.68V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3v4.68a2 2 0 0 1-1.11 1.87l-1.78.9A2 2 0 0 0 5 15.24Z"></path></svg></button>
        <button class="lp-action-btn del" onclick="delMemo('${item.id}',event)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
      </div>
      <div class="swipe-actions">${swipePin(`togglePin('${t}','${item.id}',event)`)}${swipeDel(`delMemo('${item.id}',event)`)}</div>
    </div>`;
  }
}

function renderPhotoView(items, t) {
  const grid = document.getElementById('photoGrid');
  let html = '';
  items.forEach(item => {
    let thumb = '';
    if(textTypes.includes(t) || t==='memo') thumb = getThumb(item.content);
    
    if(!thumb) return;

    const dt = new Date(item.created || item.date || Date.now());
    const day = dt.getDate();
    const ym = `${dt.getFullYear()}년 ${dt.getMonth()+1}월`;

    let clickFn = `loadDoc('${t}','${item.id}'); setMobileView('editor');`;
    if(t==='memo') clickFn = `loadMemo('${item.id}'); setMobileView('editor');`;

    html += `
      <div class="photo-cell" onclick="${clickFn}">
        <div class="photo-cell-bg" style="background-image:url('${thumb}');"></div>
        <div class="photo-overlay"></div>
        <div class="photo-date-block">
          <span class="photo-day-num">${day}</span>
          <span class="photo-ym">${ym}</span>
        </div>
      </div>
    `;
  });
  if(!html) html = '<div style="padding:40px 20px;text-align:center;color:var(--tx-hint);grid-column:1/-1;font-size:13px;">사진이 포함된 기록이 없습니다</div>';
  grid.innerHTML = html;
}

function renderCalendarView(items, t) {
  const calWrap = document.getElementById('calWrap');
  if(items.length === 0) {
    calWrap.innerHTML = '<div style="padding:40px 20px;text-align:center;color:var(--tx-hint);font-size:13px;">기록이 없습니다</div>';
    return;
  }
  
  let minDate = new Date();
  let maxDate = new Date(0);
  const entriesMap = {};
  const photoDays = {};

  items.forEach(item => {
    const dt = new Date(item.created || item.date || Date.now());
    if(dt < minDate) minDate = dt;
    if(dt > maxDate) maxDate = dt;
    
    const y = dt.getFullYear(), m = dt.getMonth()+1, d = dt.getDate();
    const key = `${y}-${m}`;
    const pKey = `${y}-${m}-${d}`;
    
    if(!entriesMap[key]) entriesMap[key] = new Set();
    entriesMap[key].add(d);

    let thumb = '';
    if(textTypes.includes(t) || t==='memo') thumb = getThumb(item.content);
    if(thumb && !photoDays[pKey]) photoDays[pKey] = thumb;
  });

  const today = new Date();
  if(minDate > today) minDate = today;
  if(maxDate < today) maxDate = today;

  let startY = minDate.getFullYear(), startM = minDate.getMonth()+1;
  let endY = maxDate.getFullYear(), endM = maxDate.getMonth()+1;
  
  const months = [];
  let cy = startY, cm = startM;
  while(cy < endY || (cy === endY && cm <= endM)) {
     months.push({y: cy, m: cm, label: `${cy}년 ${cm}월`});
     cm++;
     if(cm > 12) { cm = 1; cy++; }
  }
  months.reverse();

  const DOW = ['일','월','화','수','목','금','토'];
  let html = '';
  
  months.forEach((mo, mi) => {
    const first = new Date(mo.y, mo.m-1, 1).getDay();
    const days = new Date(mo.y, mo.m, 0).getDate();
    const key = `${mo.y}-${mo.m}`;
    const entries = entriesMap[key] ? Array.from(entriesMap[key]) : [];
    let cells = '';
    for(let i=0; i<first; i++) cells += `<div class="cal-day empty"></div>`;
    for(let d=1; d<=days; d++){
      const has = entries.includes(d);
      const isToday = (mo.y === today.getFullYear() && mo.m === today.getMonth()+1 && d === today.getDate());
      const pk = `${mo.y}-${mo.m}-${d}`;
      const thumb = photoDays[pk];
      
      let cls = 'cal-day';
      if(has) cls += ' has-entry';
      if(isToday) cls += ' today';
      
      let inner = '';
      if(thumb) {
        cls += ' has-photo';
        inner = `<div class="cal-photo-bg" style="background-image:url('${thumb}');background-size:cover;background-position:center;"></div>`;
      }
      
      const targetDateStr = `${mo.y}-${String(mo.m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const clickFn = has ? `onclick="switchListView('list'); setTagSearch('${targetDateStr}');"` : '';
      
      cells += `<div class="${cls}" ${clickFn}>${inner}<span class="cal-day-num">${d}</span></div>`;
    }
    html += `${mi>0?'<div class="cal-separator"></div>':''}
      <div class="cal-month-title">${mo.label}</div>
      <div class="cal-dow-row">${DOW.map(d=>`<div class="cal-dow">${d}</div>`).join('')}</div>
      <div class="cal-grid">${cells}</div>`;
  });

  calWrap.innerHTML = html;
}

function renderListPanel(){
  renderWritingGrid();
  const t = activeTab, el = document.getElementById('pane-list');
  const emptyState = '<div style="text-align:center;padding:80px 20px;color:var(--tx-hint);font-size:15px">기록이 없습니다</div>';

  let items = [];
  if(textTypes.includes(t)) items = getDocs(t);
  else if(t==='book') items = getBooks();
  else if(t==='quote') items = getQuotes();
  else if(t==='memo') items = getMemos();

  if(currentSearchQuery) {
    const q = currentSearchQuery.toLowerCase();
    items = items.filter(it => {
        const title = (it.title || '').toLowerCase();
        const content = (stripHtml(it.content || '')).toLowerCase();
        const tags = (it.tags || '').toLowerCase();
        const text = (it.text || '').toLowerCase();
        const by = (it.by || '').toLowerCase();
        const author = (it.author || '').toLowerCase();
        const dt = new Date(it.created || it.date || Date.now());
        const dStr = getLocalYMD(dt);
        return title.includes(q) || content.includes(q) || tags.includes(q) || text.includes(q) || by.includes(q) || author.includes(q) || dStr.includes(q);
    });
  }

  // Update Photo & Calendar views with filtered items
  if(currentListView === 'photo') renderPhotoView(items, t);
  if(currentListView === 'calendar') renderCalendarView(items, t);

  if(!items.length) { el.innerHTML = emptyState; return; }

  const pinnedItems = items.filter(i => i.pinned);
  const unpinnedItems = items.filter(i => !i.pinned);
  
  const sortFn = (a,b) => new Date(b.created||b.date||0) - new Date(a.created||a.date||0);
  pinnedItems.sort(sortFn);
  unpinnedItems.sort(sortFn);

  let html = '';

  if(pinnedItems.length > 0) {
    html += `<div class="lp-pin-hdr"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--ac-light)"><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.68V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3v4.68a2 2 0 0 1-1.11 1.87l-1.78.9A2 2 0 0 0 5 15.24Z"/></svg> 고정됨</div>`;
    pinnedItems.forEach(item => { html += generateItemHtml(item, t); });
  }

  let currentMonthStr = '';
  unpinnedItems.forEach(item => {
    const dt = new Date(item.created || item.date || Date.now());
    const mStr = getMonthYearStr(dt.toISOString());
    if (mStr !== currentMonthStr) {
      html += `<div class="lp-month-hdr">${mStr}</div>`;
      currentMonthStr = mStr;
    }
    html += generateItemHtml(item, t);
  });

  el.innerHTML = html;
}

// ═══ Toolbar & Edit Utils ═══
function execCmd(cmd,val){
  const target=activeTab==='memo'?document.getElementById('memo-body'):document.getElementById('edBody');
  target.focus();
  if(cmd==='formatBlock'&&val)document.execCommand(cmd,false,'<'+val+'>');
  else document.execCommand(cmd,false,val||null);
}
function insertChecklist(){
  const target=activeTab==='memo'?document.getElementById('memo-body'):document.getElementById('edBody');
  target.focus();
  document.execCommand('insertHTML', false, '<ul style="list-style:none;padding-left:0;"><li><input type="checkbox" style="margin-right:8px;transform:scale(1.2);"> </li></ul>');
}
function setupEnterKey() {
  document.querySelectorAll('.ed-title, .ed-tags, .sf-input').forEach(input => {
    input.addEventListener('keydown', e => {
      if(e.key === 'Enter') {
        e.preventDefault();
        const wrapper = e.target.closest('.editor-content-wrap');
        
        if(e.target.classList.contains('ed-title')) {
            const tagInput = wrapper.querySelector('.ed-tags');
            if(tagInput) tagInput.focus();
            else { const body = wrapper.querySelector('.ed-body'); if(body) body.focus(); }
        } else if (e.target.classList.contains('ed-tags') || e.target.classList.contains('sf-input')) {
            const body = wrapper.querySelector('.ed-body');
            if(body) body.focus();
        }
      }
    });
  });
}

// ── 제목 드롭다운 로직 ──
function toggleHeadingMenu() { document.getElementById('headingDropdown').classList.toggle('open'); }
function applyHeading(tag) {
  document.getElementById('headingDropdown').classList.remove('open');
  execCmd('formatBlock', tag);
}

// ── 플로팅 툴바 로직 ──
let selectionTimeout = null;
function checkSelection() {
  const sel = window.getSelection();
  const floatingToolbar = document.getElementById('floatingToolbar');
  if (!sel || sel.isCollapsed || sel.toString().trim() === '') {
    hideFloatingToolbar();
    return;
  }
  const range = sel.getRangeAt(0);
  const rect = range.getBoundingClientRect();
  if (rect.width === 0) { hideFloatingToolbar(); return; }

  floatingToolbar.classList.add('show');
  floatingToolbar.style.display = 'flex';

  const tbW = floatingToolbar.offsetWidth || 220;
  const tbH = floatingToolbar.offsetHeight || 38;
  const margin = 8;
  let left = rect.left + rect.width / 2 - tbW / 2;
  let top = rect.top + window.scrollY - tbH - margin - 6;

  if (left < margin) left = margin;
  if (left + tbW > window.innerWidth - margin) left = window.innerWidth - tbW - margin;
  if (top < margin) top = rect.bottom + window.scrollY + margin;

  floatingToolbar.style.left = left + 'px';
  floatingToolbar.style.top = top + 'px';
}
function hideFloatingToolbar() {
  const floatingToolbar = document.getElementById('floatingToolbar');
  if(floatingToolbar) {
    floatingToolbar.classList.remove('show');
    floatingToolbar.style.display = 'none';
  }
}
function applyFormatFT(cmd, val) {
  execCmd(cmd, val);
  setTimeout(checkSelection, 50);
}
function applyHighlight() {
  const target = activeTab === 'memo' ? document.getElementById('memo-body') : document.getElementById('edBody');
  target.focus();
  document.execCommand('backColor', false, '#fde68a');
  setTimeout(checkSelection, 50);
  updateWC();
  if(textTypes.includes(activeTab)) saveCurDoc(activeTab); else saveMemo();
}

// ── 팝업/드롭다운 외부 클릭 시 닫기 ──
document.addEventListener('mousedown', e => {
  const headingDropdown = document.getElementById('headingDropdown');
  const headingBtn = document.getElementById('headingBtn');
  if (headingDropdown && headingDropdown.classList.contains('open')) {
    if (headingBtn && !headingBtn.contains(e.target) && !headingDropdown.contains(e.target)) {
      headingDropdown.classList.remove('open');
    }
  }

  const floatingToolbar = document.getElementById('floatingToolbar');
  const edBody = document.getElementById('edBody');
  const memoBody = document.getElementById('memo-body');
  if (floatingToolbar && floatingToolbar.classList.contains('show')) {
    if (!floatingToolbar.contains(e.target) && !(edBody && edBody.contains(e.target)) && !(memoBody && memoBody.contains(e.target))) {
      hideFloatingToolbar();
    }
  }
});
document.addEventListener('keydown', e => { if (e.key === 'Escape') hideFloatingToolbar(); });

// ═══ Copy & Paste Handlers ═══
function setupCopyHandler() {
  document.addEventListener('copy', function(e) {
    const activeEl = document.activeElement;
    if (activeEl && activeEl.isContentEditable) {
      const selection = window.getSelection();
      if (selection.rangeCount > 0 && !selection.isCollapsed) {
        const range = selection.getRangeAt(0);
        const tempDiv = document.createElement('div');
        tempDiv.appendChild(range.cloneContents());
        if (tempDiv.querySelector('img')) return;
        e.preventDefault();
        
        let text = '';
        function traverse(el) {
            if (el.nodeType === Node.TEXT_NODE) { text += el.nodeValue; } 
            else if (el.nodeType === Node.ELEMENT_NODE) {
                const tag = el.tagName.toLowerCase();
                const isBlock = ['div', 'p', 'h1', 'h2', 'h3', 'li', 'blockquote', 'ul', 'ol'].includes(tag);
                if (isBlock && text.length > 0 && !text.endsWith('\n')) text += '\n';
                if (tag === 'br') text += '\n';
                for (let child of el.childNodes) traverse(child);
                if (isBlock && text.length > 0 && !text.endsWith('\n')) text += '\n';
            }
        }
        traverse(tempDiv);
        text = text.replace(/\n{3,}/g, '\n\n').trim();
        e.clipboardData.setData('text/plain', text);
        e.clipboardData.setData('text/html', text.replace(/\n/g, '<br>'));
      }
    }
  });
}

// ── 미디어 업로드 처리 (Paste 와 동일 로직 사용) ──
async function handleMediaUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const isImage = file.type.startsWith('image/');
  
  if(!isImage) {
    const attachHtml = `<div style="display:flex;align-items:center;gap:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin:8px 0;font-size:14px;user-select:none;">📎 ${file.name}</div><br>`;
    execCmd('insertHTML', attachHtml);
    updateWC();
    if(textTypes.includes(activeTab)) saveCurDoc(activeTab); else saveMemo();
    e.target.value = '';
    return;
  }

  const tempBlobUrl = URL.createObjectURL(file);
  const mimeType = file.type;
  const filename = 'img_' + Date.now() + (mimeType === 'image/png' ? '.png' : '.jpg');
  const tempId = 'img_' + Date.now();
  
  const imgHtml = `<img src="${tempBlobUrl}" id="${tempId}" alt="첨부이미지" style="box-sizing: border-box; border: 3px solid var(--ac-light); transition: border-color 0.3s; opacity: 1;">`;
  execCmd('insertHTML', imgHtml + '<br>');
  updateWC();
  if(textTypes.includes(activeTab)) saveCurDoc(activeTab); else saveMemo();
  
  const reader = new FileReader();
  reader.onload = async function(ev) {
    const base64Data = ev.target.result.split(',')[1];
    try {
      const res = await SYNC.uploadImage(base64Data, filename, mimeType);
      const directUrl = `https://drive.google.com/thumbnail?id=${res.id}&sz=w1000`;
      const editor = activeTab === 'memo' ? document.getElementById('memo-body') : document.getElementById('edBody');
      const imgEl = editor.querySelector(`#${tempId}`);
      if (imgEl) { imgEl.src = directUrl; imgEl.style.border = '1px solid var(--border-l)'; imgEl.removeAttribute('id'); }
      if(textTypes.includes(activeTab)) saveCurDoc(activeTab); else saveMemo();
    } catch(err) {
      console.error('Image upload failed:', err);
      const editor = activeTab === 'memo' ? document.getElementById('memo-body') : document.getElementById('edBody');
      const imgEl = editor.querySelector(`#${tempId}`);
      if (imgEl) { imgEl.style.border = '3px solid var(--red)'; imgEl.title = '업로드 실패'; imgEl.removeAttribute('id'); }
      if(textTypes.includes(activeTab)) saveCurDoc(activeTab); else saveMemo();
    }
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

async function handlePaste(e) {
  const items = (e.clipboardData || e.originalEvent.clipboardData).items;
  let hasImage = false;
  
  for (let item of items) {
    if (item.type.indexOf('image/') === 0) {
      hasImage = true;
      e.preventDefault();
      const file = item.getAsFile();
      const tempBlobUrl = URL.createObjectURL(file);
      const mimeType = file.type;
      const filename = 'img_' + Date.now() + (mimeType === 'image/png' ? '.png' : '.jpg');
      const tempId = 'img_' + Date.now();
      
      const imgHtml = `<img src="${tempBlobUrl}" id="${tempId}" alt="첨부이미지" style="box-sizing: border-box; border: 3px solid var(--ac-light); transition: border-color 0.3s; opacity: 1;">`;
      document.execCommand('insertHTML', false, imgHtml + '<br>');
      updateWC();
      if(textTypes.includes(activeTab)) saveCurDoc(activeTab); else saveMemo();
      
      const reader = new FileReader();
      reader.onload = async function(ev) {
        const base64Data = ev.target.result.split(',')[1];
        try {
          const res = await SYNC.uploadImage(base64Data, filename, mimeType);
          const directUrl = `https://drive.google.com/thumbnail?id=${res.id}&sz=w1000`;
          const editor = activeTab === 'memo' ? document.getElementById('memo-body') : document.getElementById('edBody');
          const imgEl = editor.querySelector(`#${tempId}`);
          if (imgEl) { imgEl.src = directUrl; imgEl.style.border = '1px solid var(--border-l)'; imgEl.removeAttribute('id'); }
          if(textTypes.includes(activeTab)) saveCurDoc(activeTab); else saveMemo();
        } catch(err) {
          console.error('Image upload failed:', err);
          const editor = activeTab === 'memo' ? document.getElementById('memo-body') : document.getElementById('edBody');
          const imgEl = editor.querySelector(`#${tempId}`);
          if (imgEl) { imgEl.style.border = '3px solid var(--red)'; imgEl.title = '업로드 실패'; imgEl.removeAttribute('id'); }
          if(textTypes.includes(activeTab)) saveCurDoc(activeTab); else saveMemo();
        }
      };
      reader.readAsDataURL(file);
      break; 
    }
  }
  if(!hasImage) {
    e.preventDefault();
    const text = (e.clipboardData || e.originalEvent.clipboardData).getData('text/plain');
    if(text) {
      const escapedText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const htmlText = escapedText.replace(/\r\n/g, '<br>').replace(/\n/g, '<br>');
      document.execCommand('insertHTML', false, htmlText);
    }
    setTimeout(() => { if(textTypes.includes(activeTab)) saveCurDoc(activeTab); else saveMemo(); updateWC(); }, 100);
  }
}

function setupEditorImageSelection() {
  const onImageClick = function(e) {
    if (e.target.tagName === 'IMG') {
      const range = document.createRange();
      range.selectNode(e.target);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }
  };
  document.getElementById('edBody').addEventListener('click', onImageClick);
  document.getElementById('memo-body').addEventListener('click', onImageClick);
}

// ═══ Actions ═══
function handleNew(){
  const t=activeTab;
  if(textTypes.includes(t)){const nd=newDoc(t);loadDoc(t,nd.id,true)}
  else if(t==='book')newBook();
  else if(t==='quote')newQuoteForm();
  else if(t==='memo')newMemoForm();
  renderListPanel();
  setMobileView('editor');
}

function handleDone() {
  if(document.activeElement) document.activeElement.blur();
  setMobileView('list');
}

// ═══ Mobile Gestures & UI ═══
function setupGesturesAndUI() {
  const app = document.getElementById('mainApp');
  
  let startX = 0, startY = 0;
  let isPulling = false;
  const editorEl = document.querySelector('.editor');

  app.addEventListener('touchstart', e => {
    if(window.innerWidth > 768) return;
    startX = e.touches[0].screenX;
    startY = e.touches[0].screenY;
    
    const scrollArea = e.target.closest('.editor-scroll-area');
    if (app.classList.contains('view-editor') && scrollArea && scrollArea.scrollTop <= 0) {
      isPulling = true;
    }
  }, { passive: true });

  app.addEventListener('touchmove', e => {
    if(window.innerWidth > 768) return;
    if (isPulling && app.classList.contains('view-editor')) {
      let dy = e.touches[0].screenY - startY;
      let dx = Math.abs(e.touches[0].screenX - startX);
      
      if (dy > 0 && dy > dx) {
        e.preventDefault(); 
        editorEl.style.transform = `translateX(0) translateY(${dy * 0.8}px)`; 
        editorEl.style.transition = 'none';
      }
    }
  }, { passive: false });

  app.addEventListener('touchend', e => {
    if(window.innerWidth > 768) return;
    const dx = e.changedTouches[0].screenX - startX;
    const dy = e.changedTouches[0].screenY - startY;
    
    if (Math.abs(dx) > Math.abs(dy) * 1.5 && dx > 50 && startX < 40) {
      if (app.classList.contains('view-editor')) handleDone();
      else if (app.classList.contains('view-list')) setMobileView('side');
    }
    
    if (isPulling) {
      isPulling = false;
      editorEl.style.transition = 'transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1)';
      
      if (dy > window.innerHeight * 0.35 || dy > 200) {
        handleDone(); 
      } else {
        editorEl.style.transform = `translateX(0) translateY(0)`;
      }
      setTimeout(() => { editorEl.style.transform = ''; }, 350);
    }
  }, { passive: true });
}

function setupSwipeActions(){
  // Event delegation from main view to handle swiping on .lp-item across all views 
  // (if needed, but mainly for view-list)
  const listEl=document.getElementById('pane-list');
  if(!listEl)return;
  let startX=0,startY=0,currentItem=null,swiping=false,dx=0;
  const THRESHOLD=60;

  listEl.addEventListener('touchstart',e=>{
    if(window.innerWidth>768)return;
    const item=e.target.closest('.lp-item');
    if(!item)return;
    if(currentItem&&currentItem!==item){
      currentItem.style.transform='';
      currentItem.classList.remove('swiped');
    }
    currentItem=item;
    startX=e.touches[0].clientX;
    startY=e.touches[0].clientY;
    swiping=false;dx=0;
    item.style.transition='none';
  },{passive:true});

  listEl.addEventListener('touchmove',e=>{
    if(!currentItem||window.innerWidth>768)return;
    const mx=e.touches[0].clientX-startX;
    const my=e.touches[0].clientY-startY;
    if(!swiping&&Math.abs(mx)>Math.abs(my)&&Math.abs(mx)>10)swiping=true;
    if(!swiping)return;
    e.preventDefault();
    dx=Math.min(0,mx);
    if(currentItem.classList.contains('swiped'))dx=Math.min(0,mx-160);
    currentItem.style.transform=`translateX(${dx}px)`;
  },{passive:false});

  listEl.addEventListener('touchend',e=>{
    if(!currentItem||!swiping||window.innerWidth>768)return;
    currentItem.style.transition='transform .25s ease';
    if(dx<-THRESHOLD){
      currentItem.style.transform='translateX(-160px)';
      currentItem.classList.add('swiped');
    } else {
      currentItem.style.transform='';
      currentItem.classList.remove('swiped');
    }
    swiping=false;
  },{passive:true});

  document.addEventListener('touchstart',e=>{
    if(currentItem&&!e.target.closest('.lp-item')&&!e.target.closest('.swipe-action')){
      currentItem.style.transition='transform .25s ease';
      currentItem.style.transform='';
      currentItem.classList.remove('swiped');
      currentItem=null;
    }
  },{passive:true});
}

// ═══ GAS Sync ═══
const GAS_URL='https://script.google.com/macros/s/AKfycbw3WUMJJyab2uZ33OtZVU1Rv4kvo47cqTaRecEZta4gAtaizN667CV4oZLS8q4nNUTY/exec';
const SYNC = {
  dbTimer: null, timer: null, checksTimer: null, isDbLoaded: false,
  savingDocs: {}, dirtyDocs: {}, quoteSyncHistory: {},

  setSyncStatus(text, type) {
    const el = document.getElementById('syncStatus');
    const dot = document.getElementById('syncDot');
    if(el) { el.textContent = text; }
    if(dot) {
        dot.style.background = type === 'error' ? 'var(--red)' : type === 'syncing' ? 'var(--yellow)' : '#7a9968';
        dot.style.animation = type === 'syncing' ? 'pulse 1s infinite' : 'none';
    }
  },

  async _post(data) {
    data.token = APP_TOKEN;
    data.idToken = localStorage.getItem('gb_id_token');

    if (!data.idToken) {
      throw new Error('LocalMode');
    }

    try {
      const res = await fetch(GAS_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(data) });
      const json = await res.json();
      if (json.status === 'error') {
        if (json.message === 'Unauthorized') {
          throw new Error('Unauthorized');
        } else { throw new Error(json.message); }
      }
      return json;
    } catch(e) {
      if(e.message !== 'Unauthorized' && e.message !== 'LocalMode') this.setSyncStatus('통신 지연', 'error');
      throw e;
    }
  },

  async loadDatabase() {
    try {
      const res = await this._post({ action: 'load_db' });
      if (res && res.dbData && Object.keys(res.dbData).length > 0) {
        const db = res.dbData;
        if (db[K.docs] && db[K.docs].length >= 0) S(K.docs, db[K.docs]);
        if (db[K.books]) S(K.books, db[K.books]);
        if (db[K.quotes]) S(K.quotes, db[K.quotes]);
        if (db[K.memos]) S(K.memos, db[K.memos]);
        if (db[K.checks]) S(K.checks, db[K.checks]);
        this.isDbLoaded = true;
        this.setSyncStatus('동기화 완료', 'ok');
      } else {
        this.isDbLoaded = true;
        this.setSyncStatus('신규 상태', 'ok');
      }
    } catch(e) {
        if(e.message === 'LocalMode') this.setSyncStatus('로컬 전용', 'error');
        else this.setSyncStatus('불러오기 실패', 'error');
    }
  },

  async saveDatabase() {
    if (!this.isDbLoaded) return;
    const dbData = { [K.docs]: L(K.docs) || [], [K.books]: L(K.books) || [], [K.memos]: L(K.memos) || [], [K.quotes]: L(K.quotes) || [], [K.checks]: L(K.checks) || {} };
    await this._post({ action: 'save_db', dbData: dbData });
  },

  scheduleDatabaseSave() {
    clearTimeout(this.dbTimer);
    this.dbTimer = setTimeout(async () => {
       try { await this.saveDatabase(); } catch(e) {}
    }, 3000);
  },

  async uploadImage(base64, filename, mimeType) {
    if(!GAS_URL) throw new Error("No GAS URL");
    this.setSyncStatus('업로드 중', 'syncing');
    try {
      const res = await this._post({ action: 'upload_image', bytes: base64, filename: filename, mimeType: mimeType });
      this.setSyncStatus('저장 완료', 'ok'); return res;
    } catch(e) {
      if(e.message === 'LocalMode') this.setSyncStatus('로컬 전용', 'error');
      else this.setSyncStatus('업로드 실패', 'error');
      throw e;
    }
  },

  async saveDocToGDrive(id, type) {
    if (!GAS_URL || !this.isDbLoaded) return;
    if (this.savingDocs[id]) { this.dirtyDocs[id] = type; return; }
    this.savingDocs[id] = true;

    const items = (type === 'memo') ? getMemos() : allDocs();
    const doc = items.find(d => d.id === id);
    if (!doc || !stripHtml(doc.content).trim()) { this.savingDocs[id] = false; return; }

    try {
      const res = await this._post({ action: 'save_doc', id: doc.id, driveId: doc.driveId || null, type: type, title: doc.title || today(), content: stripHtml(doc.content) });
      if (res && res.driveId) {
        const freshItems = (type === 'memo') ? getMemos() : allDocs();
        const freshDoc = freshItems.find(d => d.id === doc.id);
        if (freshDoc && freshDoc.driveId !== res.driveId) {
          freshDoc.driveId = res.driveId;
          if (type === 'memo') saveMemos(freshItems); else saveDocs(freshItems);
        }
      }
    } finally {
      this.savingDocs[id] = false;
      if (this.dirtyDocs[id]) {
        const nextType = this.dirtyDocs[id];
        delete this.dirtyDocs[id];
        this.saveDocToGDrive(id, nextType).catch(()=>{});
      }
    }
  },

  scheduleChecksSave(){
      clearTimeout(this.checksTimer);
      this.checksTimer=setTimeout(async ()=>{
          try { await this.saveChecksToSheet(); } catch(e){}
          this.scheduleDatabaseSave();
      },400)
  },

  async saveChecksToSheet(dateStr, checkData){
      if(!GAS_URL || !this.isDbLoaded)return;
      const dStr=dateStr||today();
      const dData=checkData||getChk();
      const p={action:'save_routine',date:dStr,checks:dData};
      const pk=JSON.stringify(p);
      if(this.checksSaving){this.checksPending=true;return}
      if(pk===this.lastChecksPayload)return;

      this.checksSaving=true;
      try{
          await this._post(p);
          this.lastChecksPayload=pk;
      }finally{
          this.checksSaving=false;
          if(this.checksPending){
              this.checksPending=false;
              try { await this.saveChecksToSheet(); } catch(e){}
          }
      }
  },

  scheduleBookSave(book) { clearTimeout(this.bookTimer); this.bookTimer = setTimeout(async () => { try{await this.saveBooksToSheet(book);}catch(e){} this.scheduleDatabaseSave(); }, 5000); },
  scheduleQuoteSave(text, by, id) { clearTimeout(this.quoteTimer); this.quoteTimer = setTimeout(async () => { if (!this.quoteSyncHistory[id]) { try{await this.saveQuotesToSheet(text, by);}catch(e){} this.quoteSyncHistory[id] = true; } this.scheduleDatabaseSave(); }, 5000); },

  async saveQuotesToSheet(text,by){
      if(!GAS_URL || !this.isDbLoaded)return;
      await this._post({action:'save_quote',text:text||'',by:by||''});
  },

  async saveBooksToSheet(book) {
    if(!GAS_URL || !book || !this.isDbLoaded) return;
    const res = await this._post({ action:'save_doc', id: book.id, driveId: book.driveId, type:'book', title:book.title, content:'저자: '+(book.author||'')+'\n출판사: '+(book.publisher||'')+'\n읽은 양: '+(book.pages||0)+'p\n\n'+stripHtml(book.memo||'') });
    if (res && res.driveId) {
      const books = getBooks(); const idx = books.findIndex(b => b.id === book.id);
      if (idx !== -1 && books[idx].driveId !== res.driveId) { books[idx].driveId = res.driveId; saveBooks(books); }
    }
  },

  scheduleDocSave(type){
      clearTimeout(this.timer);
      this.timer = setTimeout(async () => {
          let id = (type === 'memo') ? curMemoId : curIds[type];
          if(id) { try { await this.saveDocToGDrive(id, type); } catch(e){} }
          this.scheduleDatabaseSave();
      }, 5000);
  },

  async syncAll() {
    if(!this.isDbLoaded) return;
    clearTimeout(this.timer);
    this.setSyncStatus('동기화 중', 'syncing');

    try {
      const promises = [];
      for(const type of textTypes){
        if(curIds[type]) promises.push(this.saveDocToGDrive(curIds[type], type));
      }
      if(curMemoId) promises.push(this.saveDocToGDrive(curMemoId, 'memo'));
      promises.push(this.saveDatabase());

      await Promise.all(promises);
      this.setSyncStatus('완료됨', 'ok');
    } catch (e) {
      if(e.message === 'LocalMode') {
        this.setSyncStatus('로컬 전용', 'error');
      } else {
        this.setSyncStatus('통신 지연', 'error');
      }
    }
  }
};

// ═══ Auto-save ═══
let _at = null;
function setupAutoSave(){
  const showSaving = () => { if(document.getElementById('edSaveStatus')) document.getElementById('edSaveStatus').textContent = '저장 중...'; };
  const showSaved = () => { if(document.getElementById('edSaveStatus')) document.getElementById('edSaveStatus').textContent = '저장됨'; };

  const saveLocalOnly = () => {
    if(textTypes.includes(activeTab)){ saveCurDoc(activeTab); showSaved(); }
    else if(activeTab==='memo'){ saveMemo(); showSaved(); }
    else if(activeTab==='book'){ saveBook(); showSaved(); }
    else if(activeTab==='quote'){ saveQuote(); showSaved(); }
  };

  const doSaveAndSync = () => { saveLocalOnly(); SYNC.scheduleDatabaseSave(); if(textTypes.includes(activeTab)) SYNC.scheduleDocSave(activeTab); else if(activeTab==='memo') SYNC.scheduleDocSave('memo'); };

  const onInput = () => { showSaving(); clearTimeout(_at); _at = setTimeout(doSaveAndSync, 800); updateWC(); };

  const els = ['edBody', 'edTitle', 'edTags', 'memo-body', 'memo-title', 'memoTags', 'book-title', 'book-author', 'book-publisher', 'book-pages', 'book-body', 'quote-by', 'quote-body'];
  els.forEach(id => { const el = document.getElementById(id); if(el) { el.addEventListener('input', onInput); el.addEventListener('blur', () => { setTimeout(() => { saveLocalOnly(); }, 200); }); } });

  document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden') { clearTimeout(_at); saveLocalOnly(); SYNC.syncAll(); } });
}

// ═══ Init ═══
function init(){
  try{
    if(localStorage.getItem('gb_sidebar_closed') === '1') { document.getElementById('mainApp').classList.add('sidebar-closed'); }

    renderChk();updateBookStats();updateWritingStats();showRandomQuote();setupAutoSave();setupEnterKey();setupSwipeActions();
    setupCopyHandler();
    
    document.getElementById('edBody').addEventListener('paste', handlePaste); 
    document.getElementById('memo-body').addEventListener('paste', handlePaste);
    
    const checkSelWrapper = () => { clearTimeout(selectionTimeout); selectionTimeout = setTimeout(checkSelection, 50); };
    document.getElementById('edBody').addEventListener('mouseup', checkSelWrapper);
    document.getElementById('edBody').addEventListener('keyup', (e) => { if(e.shiftKey) checkSelWrapper(); });
    document.getElementById('memo-body').addEventListener('mouseup', checkSelWrapper);
    document.getElementById('memo-body').addEventListener('keyup', (e) => { if(e.shiftKey) checkSelWrapper(); });
    
    setupEditorImageSelection();
    setupGesturesAndUI();
    
    const naviDocs=getDocs('navi');if(naviDocs.length)loadDoc('navi',naviDocs[0].id,true);else{const nd=newDoc('navi');loadDoc('navi',nd.id,true)}
    if(GAS_URL)SYNC.setSyncStatus('완료됨','ok');else SYNC.setSyncStatus('로컬 전용','error');
    
    switchListView('list');
  }catch(e){console.error('init error:',e);alert('초기화 오류: '+e.message)}
}
</script>
</body>
</html>
