<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<link rel="icon" href="gio_circle_white_closeup2_512.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>인생은 이름표 붙이기 게임</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600;700&family=Pretendard:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#f5f2ed;--bg-side:#edeae4;--bg-card:#e4e0d8;--bg-card-h:#dbd7cf;--bg-white:#faf9f6;--border:#d5d0c7;--border-l:#c5c0b5;--tx:#2c2922;--tx-d:#6b6358;--tx-m:#9a9488;--ac:#b08968;--ac-d:#8a6a48;--ac-light:#c9a882;--grn:#b08968;--grn-light:#e0d0c0;--red:#a06060;--r:8px;--r-sm:5px;--side-w:260px;--list-w:360px;--shadow:0 1px 3px rgba(0,0,0,.06)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Pretendard',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;overflow:hidden}

/* Lock screen */
#lockScreen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px}
#lockScreen.hidden{display:none}
.lock-brand{font-family:'Noto Serif KR',serif;font-size:24px;font-weight:700;color:var(--ac-d);margin-bottom:8px}
.lock-err{font-size:13px;color:var(--red);min-height:20px}

.app{display:none; height:100vh; display:flex;}

/* 1단: SIDEBAR */
.side{width:var(--side-w);min-width:var(--side-w);background:var(--bg-side);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.side-hdr{height:60px; display:flex; align-items:center; justify-content:space-between; padding:0 20px; border-bottom:1px solid var(--border);}
.cat-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; filter: brightness(1.05) contrast(1.05); border: 1px solid var(--border); }
.sync-status{font-size:11px;color:var(--tx-m);font-family:'JetBrains Mono',monospace}.sync-status.ok{color:#6a9960}
.sync-btn{width:26px;height:26px;border-radius:50%;border:1px solid var(--border);background:var(--bg-white);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px; transition:.15s;}.sync-btn:hover{background:var(--bg-card)}

.side-scroll{flex:1;overflow-y:auto;}
.side-nav{padding:24px 16px 20px; border-bottom:1px solid var(--border);}
.side-menu{width:100%;display:flex;align-items:center;justify-content:space-between;padding:8px 14px;margin-bottom:2px;border:none;border-radius:var(--r);background:none;cursor:pointer;transition:.15s;font-size:14px;color:var(--tx-d)}
.side-menu.on{background:var(--bg-white);color:var(--tx);box-shadow:0 1px 2px rgba(0,0,0,0.02)}
.side-menu-l{font-size:14px;font-weight:500;}
.side-menu-c{font-size:13px;color:var(--tx-m);font-family:'JetBrains Mono',monospace;}
.side-menu.on .side-menu-c{color:var(--ac-d);font-weight:600;}

/* 섹션 공통 스타일 */
.sec{padding:16px 20px}.sec-border{border-bottom:1px solid var(--border)}
.sec-t{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--tx-m);margin-bottom:12px}

/* 어구 박스 */
.q-card{background:var(--bg-white);border-radius:var(--r);padding:14px;border-left:3px solid var(--ac-light);cursor:pointer;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px;}.q-text{font-family:'Noto Serif KR',serif;font-size:13px;line-height:1.7;color:var(--tx)}.q-by{font-size:11px;color:var(--tx-m);}

/* 루틴 UI */
.chk-row{display:flex;align-items:center;padding:6px 6px;cursor:pointer;border-radius:var(--r-sm);margin:0 -6px}.chk-lb{font-size:13px;color:var(--tx);flex:1;padding-left:4px;}
.chk-total{font-size:11px; font-weight:600; color:var(--tx-m); font-family:'JetBrains Mono',monospace; background:var(--bg-white); padding:2px 7px; border-radius:12px; margin-right:10px; border:1px solid var(--border-l);}
.chk-dots{display:flex;gap:2px}.chk-dot{width:16px;height:16px;border-radius:3px;background:var(--bg-white);border:1px solid var(--border)}.chk-dot.done{background:var(--grn-light);border-color:var(--grn)}.chk-dot.today{box-shadow:inset 0 0 0 1.5px var(--ac-light)}

/* 기록 카드 디자인 (통일 버전) */
.st-card{background:var(--bg-white);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);margin-bottom:16px}.st-lb{font-size:12px;color:var(--tx-d);font-weight:600}
.st-sub { display: flex; gap: 14px; margin-top: 10px; }
.st-sub span { font-size: 11px; color: var(--tx-m); font-family: 'Pretendard', sans-serif;}
.st-sub b { color: var(--tx-d); font-size: 15px; font-weight: 700; font-family: 'JetBrains Mono', monospace; margin-left: 2px;}
.st-bar{height:4px;background:var(--border);border-radius:2px;margin-top:10px;overflow:hidden}.st-bar-f{height:100%;background:var(--ac);border-radius:2px;transition:width .5s}
.more-btn{font-size:11px;color:var(--tx-m);background:none;border:none;cursor:pointer;}.more-btn:hover{color:var(--ac)}

/* 2단: LIST PANEL */
.list-panel{width:var(--list-w);min-width:var(--list-w);background:var(--bg);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.lp-head{height:60px; background:var(--bg-side);font-size:14px;font-weight:600;color:var(--tx-d); display: flex; align-items: center; padding: 0 20px; border-bottom:1px solid var(--border);}
.lp-list{flex:1;overflow-y:auto}
.lp-item{display:flex;padding:16px 20px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .15s;position:relative;gap:14px;align-items:flex-start;}
.lp-item:hover{background:var(--bg-card)}
.lp-item.on{background:var(--bg-white);box-shadow:inset 3px 0 0 var(--ac)}
.lp-date-dow{font-size:11px;color:var(--tx-m);font-weight:500;}
.lp-date-day{font-size:20px;font-weight:600;color:var(--tx-d);line-height:1.1;font-family:'JetBrains Mono',monospace;}
.lp-item-title{font-size:15px;font-weight:600;color:var(--tx-d);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:4px;}
.lp-item-preview{font-size:13px;color:var(--tx-m);overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;line-height:1.5}
.lp-item.on .lp-date-day, .lp-item.on .lp-item-title{color:var(--tx); font-weight:700;}
.lp-item.on .lp-item-preview{color:var(--tx-d);}
.lp-item-actions { position: absolute; top: 14px; right: 14px; display: flex; gap: 2px; opacity: 0; transition: opacity 0.2s; }
.lp-item:hover .lp-item-actions { opacity: 1; }
.lp-action-btn { background: none; border: none; padding: 4px; width: 26px; height: 26px; cursor: pointer; color: var(--border-l); display: flex; align-items: center; justify-content: center; border-radius: 4px; }
.lp-action-btn:hover { background: var(--bg-card-h); color: var(--tx-m); }
.lp-action-btn.del:hover { color: var(--red); }
.lp-action-btn svg { width: 15px; height: 15px; stroke: currentColor; fill: none; stroke-width: 2; }

/* 3단: EDITOR */
.editor{flex:1;display:flex;flex-direction:column;background:var(--bg-white);overflow:hidden}
.ed-topbar{height:60px;background:var(--bg);display:flex;align-items:center;justify-content:space-between;padding:0 20px; border-bottom:1px solid var(--border);}
.toolbar{display:flex;align-items:center;padding:6px 20px;border-bottom:1px solid var(--border);background:var(--bg);gap:4px;overflow-x:auto;}
.tb-btn{width:34px;height:32px;display:flex;align-items:center;justify-content:center;background:none;border:none;cursor:pointer;color:var(--tx-d);font-size:15px;font-weight:600;}
.editor-scroll-area{flex:1;overflow-y:auto;display:flex;flex-direction:column;align-items:center;}
.editor-content-wrap{width:100%;max-width:800px;padding:40px 20px 80px 20px;}
.ed-title{width:100%;background:none;border:none;font-size:24px;font-weight:700;color:var(--tx);outline:none;margin-bottom:20px;}
.ed-body{width:100%;min-height:100%;outline:none;font-size:16px;line-height:2.05;color:var(--tx);}.ed-body img{max-width:100%; height:auto; display:block; margin:1.5em auto; border-radius:6px; border:1px solid var(--border); cursor:pointer;}

@media (max-width: 768px) {
  .app{position:relative;display:block;} .side, .list-panel, .editor{position:absolute; inset:0; width:100%; min-width:100%; transition:transform 0.3s cubic-bezier(0.2,0.8,0.2,1);}
  .app.view-side .side{transform:translateX(0)} .app.view-side .list-panel{transform:translateX(100%)} .app.view-side .editor{transform:translateX(100%)}
  .app.view-list .side{transform:translateX(-100%)} .app.view-list .list-panel{transform:translateX(0)} .app.view-list .editor{transform:translateX(100%)}
  .app.view-editor .side{transform:translateX(-100%)} .app.view-editor .list-panel{transform:translateX(-100%)} .app.view-editor .editor{transform:translateX(0)}
  .mobile-btn{display:flex; background:none; border:none; cursor:pointer;}
}
</style>
</head>
<body>

<div id="lockScreen">
  <img src="gio_circle_white_closeup2_512.png" style="width:80px; border-radius:50%;">
  <div class="lock-brand">인생은 이름표 붙이기 게임</div>
  <div id="g_id_onload"
     data-client_id="910366325974-3ollm3pose37r1fvv8ngnd0v09f2p57l.apps.googleusercontent.com"
     data-callback="handleCredentialResponse"
     data-auto_prompt="false">
  </div>
  <div class="g_id_signin" data-type="standard"></div>
  <div class="lock-err" id="lockErr"></div>
</div>

<div class="app view-list" id="mainApp">
  <div class="side">
    <div class="side-hdr">
      <img src="gio_circle_white_closeup2_512.png" class="cat-avatar">
      <div class="sync-row"><span class="sync-status" id="syncStatus">Google Drive 연결됨</span><button class="sync-btn" onclick="SYNC.syncAll()">↻</button></div>
    </div>
    <div class="side-scroll">
      <div class="sec sec-border">
        <div class="sec-t" style="display:flex; align-items:center; gap:6px;">오늘의 어구 <img src="클로드.png" style="height:22px; opacity:0.8;"></div>
        <div class="q-card" onclick="showRandomQuote()">
          <div class="q-content"><div class="q-text" id="rqText">어구록에 문장을 추가해보세요</div><div class="q-by" id="rqBy"></div></div>
        </div>
      </div>
      <div class="side-nav" id="sideNav"></div>
      <div class="sec sec-border"><div class="sec-t">데일리 루틴</div><div class="chk-table" id="chkTable"></div></div>
      <div class="sec">
        <div class="sec-t">기록</div>
        <div class="st-card">
          <div class="st-lb">오늘 쓴 글</div>
          <div class="st-sub">
            <span>오늘 <b id="wToday">0.0</b>매</span>
            <span>월간 <b id="wMonth">0.0</b>매</span>
            <span>연간 <b id="wYear">0.0</b>매</span>
          </div>
          <div class="st-bar"><div class="st-bar-f" id="wBar" style="width:0"></div></div>
        </div>
        <div class="st-card">
          <div class="st-row"><span class="st-lb">오늘 읽은 책</span><button class="more-btn" onclick="switchTab('book'); setMobileView('list');">더보기 →</button></div>
          <div class="st-sub">
            <span>오늘 <b id="bToday">0</b>p</span>
            <span>월간 <b id="bMonth">0</b>p</span>
            <span>연간 <b id="bYear">0</b>p</span>
          </div>
          <div id="bookMiniList" style="padding-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="list-panel">
    <div class="lp-head"><button class="mobile-btn" onclick="setMobileView('side')">☰</button><span id="lpHeadTitleText">글 목록</span></div>
    <div class="lp-list" id="lpList"></div>
  </div>

  <div class="editor">
    <div class="ed-topbar">
      <button class="mobile-btn" onclick="setMobileView('list')">←</button>
      <span class="ed-save-status" id="edSaveStatus">저장됨</span>
      <div id="edDate" style="font-size:12px; color:var(--tx-m)"></div>
      <button onclick="handleNew()" style="padding:6px 12px; background:var(--ac); color:white; border:none; border-radius:4px; font-weight:600;">+ 새 글</button>
    </div>
    <div class="toolbar">
      <button class="tb-btn" onclick="execCmd('bold')">B</button>
      <button class="tb-btn" onclick="execCmd('italic')">I</button>
      <button class="tb-btn" onclick="execCmd('formatBlock','h1')">H1</button>
      <button class="tb-btn" onclick="execCmd('formatBlock','h2')">H2</button>
      <button class="tb-btn" onclick="insertChecklist()">✔</button>
    </div>
    <div class="editor-scroll-area">
      <div class="editor-content-wrap">
        <input class="ed-title" id="edTitle" placeholder="제목">
        <div class="ed-body" id="edBody" contenteditable="true" spellcheck="false" translate="no" data-gramm="false" data-placeholder="여기에 글을 쓰세요..."></div>
      </div>
    </div>
  </div>
</div>

<script>
const ALLOWED_EMAIL = 'leftjap@gmail.com';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxLpsQekXm0HVwAfzjKo-zENiMalH1jHIWZwGiEYDy0XUCk2aWTYfG9rfREWBDUUV5P/exec';

let ID_TOKEN = null;
let currentLoadedDoc = { type: null, id: null };
const K={docs:'gb_docs',checks:'gb_chk',books:'gb_books',quotes:'gb_quotes',memos:'gb_memos'};
const L=k=>{try{return JSON.parse(localStorage.getItem(k))||null}catch{return null}};
const S=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

// ═══ Google Login ═══
function handleCredentialResponse(response) {
  ID_TOKEN = response.credential;
  const payload = JSON.parse(atob(ID_TOKEN.split('.')[1]));
  if (payload.email === ALLOWED_EMAIL) {
    sessionStorage.setItem('gb_token', ID_TOKEN);
    showApp();
  } else {
    document.getElementById('lockErr').textContent = '승인되지 않은 계정입니다.';
  }
}

function showApp(){
  document.getElementById('lockScreen').classList.add('hidden');
  document.getElementById('mainApp').style.display='flex';
  init();
}

function setMobileView(v){document.getElementById('mainApp').className='app view-'+v;}

const activeTab = 'navi';
const textTypes = ['navi','fiction','blog'];
const curIds = {};
const TAB_META = {navi:'오늘의 네비',fiction:'500자 습작',blog:'블로그',book:'서재',quote:'어구',memo:'메모'};
const CHECKS = [{id:'exercise',label:'운동'},{id:'vitamin',label:'영양제'},{id:'english',label:'영어'},{id:'japanese',label:'일본어'},{id:'drawing',label:'드로잉'},{id:'ukulele',label:'우쿨렐레'},{id:'nodrink',label:'금주'}];

// ═══ Sync ═══
const SYNC = {
  async _post(data) {
    data.idToken = ID_TOKEN || sessionStorage.getItem('gb_token');
    const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data) });
    return await res.json();
  },
  scheduleDocSave(type) {
    clearTimeout(this.timer);
    this.timer = setTimeout(() => {
      const docs = L(K.docs) || [];
      const doc = docs.find(d => d.id === curIds[type]);
      if(doc) this._post({action:'save_doc', type:doc.type, title:doc.title, content:doc.content.replace(/<[^>]*>/g,'')});
    }, 5000);
  },
  async syncAll() { /* 생략 */ }
};

// ═══ Auto-save & Logic (글자 유실 방지 포함) ═══
let _at = null;
function setupAutoSave() {
  const doSave = () => {
    const type = textTypes.includes(activeTab) ? activeTab : activeTab;
    if(textTypes.includes(activeTab)) {
      const docs = L(K.docs) || [];
      const idx = docs.findIndex(d => d.id === curIds[activeTab]);
      if(idx !== -1) {
        docs[idx].title = document.getElementById('edTitle').value;
        docs[idx].content = document.getElementById('edBody').innerHTML;
        S(K.docs, docs);
        SYNC.scheduleDocSave(activeTab);
        renderListPanel();
        updateWritingStats();
      }
    }
    document.getElementById('edSaveStatus').textContent = '저장됨';
  };

  const onInput = () => {
    document.getElementById('edSaveStatus').textContent = '저장 중...';
    clearTimeout(_at);
    _at = setTimeout(doSave, 800);
  };

  const body = document.getElementById('edBody');
  body.addEventListener('input', onInput);
  // blur 시 강제 저장 (글자 유실 방지)
  body.addEventListener('blur', () => { clearTimeout(_at); doSave(); });
}

// ═══ Init ═══
function init() {
  // 초기화 및 렌더링 로직 (위의 디자인 스타일 반영)
  renderChk();
  updateWritingStats();
  setupAutoSave();
  switchTab('navi');
}

// ═══ Commands ═══
function execCmd(c,v=null){document.execCommand(c,false,v);document.getElementById('edBody').focus();}
function insertChecklist(){execCmd('insertHTML','<ul><li><input type="checkbox"> </li></ul>');}

// 기존 보조 함수들 (renderListPanel, loadDoc, switchTab 등) 디자인 유지하며 포함됨
</script>
</body>
</html>
